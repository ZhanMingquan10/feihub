# 测试 Puppeteer 爬取飞书文档

## ✅ 准备工作已完成

- ✅ Puppeteer-core 已安装
- ✅ 代码已优化
- ✅ 错误处理已完善

## 🚀 测试步骤

### 第一步：重新启动后端服务

**重要**：必须重启后端服务才能加载新的 Puppeteer 代码！

1. **停止当前后端服务**
   - 在运行后端的窗口按 `Ctrl+C`
   - 等待服务完全停止

2. **重新启动后端服务**
   - 运行 `backend/完整启动.bat` 或 `backend/最简单启动.bat`
   - 等待看到：`🚀 Server running on http://localhost:4000`

3. **检查 Puppeteer 是否加载**
   - 查看后端控制台，应该看到：
     ```
     [爬取] Puppeteer 可用，将使用 Puppeteer 方案
     ```

### 第二步：清理旧数据（可选）

如果想测试新的爬取逻辑，可以清理旧数据：

运行 `backend/重新处理文档.bat`

### 第三步：提交测试文档

1. **打开前端页面**
   - 访问：http://localhost:5173

2. **提交飞书文档链接**
   - 点击右下角"分享文档"按钮
   - 输入链接：`https://ai.feishu.cn/wiki/UW5NwEY4wibWd2kUR9nc7vgCnvc`
   - 点击"确定"

3. **观察后端控制台**
   - 应该看到类似日志：
     ```
     [Puppeteer] 开始获取飞书文档: https://...
     [Puppeteer] Using browser at: C:\Program Files\Google\Chrome\Application\chrome.exe
     [Puppeteer] 正在加载页面...
     [Puppeteer] 页面加载完成，HTML 长度: xxxx
     [Puppeteer] 提取的标题: xxx
     [Puppeteer] 提取的作者: xxx
     [Puppeteer] 从页面直接提取内容，长度: xxx
     [Puppeteer] 最终内容长度: xxx
     ```

### 第四步：验证结果

1. **等待处理完成**（约 10-30 秒）
   - 查看后端控制台是否显示：`文档处理完成`

2. **刷新前端页面**
   - 按 `F5` 刷新
   - 检查文档是否正确显示：
     - ✅ 标题是否正确（不是"未命名文档"）
     - ✅ 作者是否正确（不是"社区贡献者"）
     - ✅ 内容是否正确（不是"文档内容无法自动提取"）

## 🔍 如果遇到问题

### 问题 1：Chrome 未找到

**错误信息**：`Chrome browser not found`

**解决方案**：
1. 确保已安装 Chrome 浏览器
2. 如果 Chrome 在非默认位置，设置环境变量：
   ```bash
   set CHROME_PATH=C:\Your\Chrome\Path\chrome.exe
   ```

### 问题 2：Puppeteer 启动失败

**错误信息**：`Failed to launch browser`

**可能原因**：
- Chrome 路径不正确
- 权限问题
- 系统依赖缺失

**解决方案**：
- 检查 Chrome 是否正确安装
- 查看后端控制台的详细错误信息

### 问题 3：内容提取失败

**现象**：标题或内容仍然是默认值

**可能原因**：
- 飞书文档需要登录才能查看
- 文档是私密的
- 页面结构变化

**解决方案**：
- 确保文档是公开的
- 查看后端控制台的详细日志
- 检查提取的选择器是否正确

## 📊 预期结果

如果一切正常，你应该看到：

1. **后端日志**：
   - `[Puppeteer]` 开头的日志
   - 成功提取标题、作者、内容

2. **前端显示**：
   - 正确的文档标题
   - 正确的作者名称
   - 完整的文档内容（不是默认提示）

3. **处理时间**：
   - 约 10-30 秒（取决于文档大小和网络速度）

## 🎉 成功标志

- ✅ 后端控制台显示 Puppeteer 成功提取内容
- ✅ 前端页面显示正确的文档信息
- ✅ 文档内容完整（不是默认提示）

---

**现在可以开始测试了！** 🚀


