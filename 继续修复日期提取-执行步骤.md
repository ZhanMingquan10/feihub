# ç»§ç»­ä¿®å¤æ—¥æœŸæå– - æ‰§è¡Œæ­¥éª¤

## ğŸ”§ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä¿®å¤è„šæœ¬

åœ¨å®å¡”ç»ˆç«¯æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

# åˆ›å»ºä¿®å¤è„šæœ¬
cat > /tmp/continue_fix.sh << 'SCRIPT_EOF'
#!/bin/bash

cd /www/wwwroot/feihub/backend/src/lib

# å¤‡ä»½
cp feishu-puppeteer.ts feishu-puppeteer.ts.backup2

# ä¿®å¤1: åœ¨ "é¢å¤–ç­‰å¾…3ç§’" ä¹‹åæ·»åŠ ç­‰å¾…æ—¥æœŸå…ƒç´ çš„ä»£ç 
line_num=$(grep -n "é¢å¤–ç­‰å¾…3ç§’ï¼Œç¡®ä¿å†…å®¹å®Œå…¨æ¸²æŸ“" feishu-puppeteer.ts | cut -d: -f1)
if [ -n "$line_num" ]; then
    next_line=$((line_num + 1))
    sed -i "${next_line}a\\
\\
    // é¢å¤–ç­‰å¾…ï¼Œç¡®ä¿æ—¥æœŸå…ƒç´ ä¹ŸåŠ è½½å®Œæˆï¼ˆé£ä¹¦çš„æ—¥æœŸå…ƒç´ å¯èƒ½éœ€è¦æ›´é•¿æ—¶é—´ï¼‰\\
    console.log(\`[Puppeteer] é¢å¤–ç­‰å¾…ï¼Œç¡®ä¿æ—¥æœŸå…ƒç´ åŠ è½½å®Œæˆ...\`);\\
\\
    // ç­‰å¾…æ—¥æœŸå…ƒç´ å‡ºç°ï¼ˆæœ€å¤šç­‰å¾…10ç§’ï¼‰\\
    try {\\
      await page.waitForSelector('.doc-info-time-item', { timeout: 10000 });\\
      console.log(\`[Puppeteer] âœ… æ‰¾åˆ°æ—¥æœŸå…ƒç´  .doc-info-time-item\`);\\
\\
      // ç«‹å³æå–æ—¥æœŸå…ƒç´ çš„å†…å®¹ï¼Œç”¨äºè°ƒè¯•\\
      const dateElementText = await page.evaluate(() => {\\
        const el = document.querySelector('.doc-info-time-item');\\
        if (el) {\\
          return (el.innerText || el.textContent || '').trim();\\
        }\\
        return null;\\
      });\\
      console.log(\`[Puppeteer] ğŸ“… æ—¥æœŸå…ƒç´ å†…å®¹: \"\${dateElementText}\"\`);\\
    } catch (e) {\\
      console.warn(\`[Puppeteer] âš ï¸ æœªæ‰¾åˆ°æ—¥æœŸå…ƒç´  .doc-info-time-itemï¼Œç»§ç»­æå–...\`);\\
    }\\
\\
    // å†ç­‰å¾…3ç§’ï¼Œç¡®ä¿æ‰€æœ‰å†…å®¹å®Œå…¨æ¸²æŸ“\\
    await new Promise(resolve => setTimeout(resolve, 3000));
" feishu-puppeteer.ts
    echo "âœ… å·²æ·»åŠ ç­‰å¾…æ—¥æœŸå…ƒç´ çš„ä»£ç "
fi

# ä¿®å¤2: åœ¨ pageData æå–çš„æ—¥æœŸéƒ¨åˆ†ï¼Œä¼˜å…ˆæŸ¥æ‰¾ .doc-info-time-item
date_line=$(grep -n "// 3. æå–æ—¥æœŸ - æŸ¥æ‰¾æ›´æ–°æ—¶é—´" feishu-puppeteer.ts | cut -d: -f1)
if [ -n "$date_line" ]; then
    next_date_line=$((date_line + 1))
    sed -i "${next_date_line}a\\
      // ä¼˜å…ˆæŸ¥æ‰¾ .doc-info-time-itemï¼ˆé£ä¹¦æ–‡æ¡£çš„ä¿®æ”¹æ—¶é—´ï¼‰\\
      const docInfoTimeEl = document.querySelector('.doc-info-time-item') as HTMLElement | null;\\
      if (docInfoTimeEl) {\\
        const timeText = (docInfoTimeEl.innerText || docInfoTimeEl.textContent || '').trim();\\
        if (timeText && timeText.length > 3) {\\
          result.date = timeText;\\
          console.log(\`[Puppeteer] âœ… æ‰¾åˆ°æ—¥æœŸæ¥æº: .doc-info-time-item, å†…å®¹: \"\${timeText}\"\`);\\
        }\\
      }\\
\\
      // å¦‚æœè¿˜æ²¡æ‰¾åˆ°ï¼Œç»§ç»­ä½¿ç”¨å…¶ä»–é€‰æ‹©å™¨
" feishu-puppeteer.ts
    echo "âœ… å·²æ·»åŠ ä¼˜å…ˆæŸ¥æ‰¾ .doc-info-time-item çš„ä»£ç "
fi

# ä¿®å¤3: æ”¹è¿›æ—¥æœŸè§£ææ—¥å¿—
sed -i 's/dateText = parseChineseDate(dateText);/console.log(`[Puppeteer] å‡†å¤‡è§£ææ—¥æœŸ: "${dateText}"`);\
      dateText = parseChineseDate(dateText);\
      console.log(`[Puppeteer] è§£æåçš„æ—¥æœŸ: "${dateText}"`);/' feishu-puppeteer.ts

echo "ä¿®å¤å®Œæˆï¼"
SCRIPT_EOF

chmod +x /tmp/continue_fix.sh
/tmp/continue_fix.sh
```

---

## âœ… éªŒè¯ä¿®å¤

```bash
cd /www/wwwroot/feihub/backend/src/lib

# æ£€æŸ¥æ˜¯å¦æ·»åŠ æˆåŠŸ
grep -n "é¢å¤–ç­‰å¾…ï¼Œç¡®ä¿æ—¥æœŸå…ƒç´ åŠ è½½å®Œæˆ" feishu-puppeteer.ts
grep -n "æ‰¾åˆ°æ—¥æœŸå…ƒç´ " feishu-puppeteer.ts
grep -n "æ‰¾åˆ°æ—¥æœŸæ¥æº: .doc-info-time-item" feishu-puppeteer.ts
grep -n "å‡†å¤‡è§£ææ—¥æœŸ" feishu-puppeteer.ts
```

---

## ğŸš€ é‡æ–°æ„å»ºå’Œéƒ¨ç½²

```bash
cd /www/wwwroot/feihub/backend

# é‡æ–°æ„å»º
npm run build

# æ£€æŸ¥æ„å»ºæ˜¯å¦æˆåŠŸ
if [ $? -eq 0 ]; then
    echo "âœ… æ„å»ºæˆåŠŸ"
    
    # å®Œå…¨é‡å¯ PM2
    pm2 stop feihub-backend
    pm2 delete feihub-backend
    pm2 start npm --name feihub-backend -- run start
    
    # ç­‰å¾…å¯åŠ¨
    sleep 5
    
    # æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
    pm2 logs feihub-backend --lines 30 --nostream | grep -E "(å¯åŠ¨|CHROME_PATH|é”™è¯¯)" | tail -10
else
    echo "âŒ æ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥é”™è¯¯ä¿¡æ¯"
fi
```

---

## ğŸ§ª æµ‹è¯•

æäº¤æµ‹è¯•æ–‡æ¡£åï¼Œåº”è¯¥èƒ½çœ‹åˆ°å®Œæ•´çš„æ—¥æœŸæå–æ—¥å¿—ã€‚

