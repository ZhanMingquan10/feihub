# 问题排查指南

## 当前问题
- ✅ 数据库查询正常
- ❌ 数据库中没有文档记录
- ❓ 文档可能还在处理中或处理失败

## 排查步骤

### 第一步：运行详细诊断

双击运行 `backend/详细诊断.bat`

这会显示：
1. Document 表的记录数（应该是 0）
2. DocumentSubmission 表的状态（pending/processing/completed/failed）
3. 各状态的提交数量
4. 如果有失败的提交，显示错误信息

### 第二步：查看后端控制台

查看运行后端服务的窗口，应该能看到：

**如果文档正在处理：**
```
收到文档提交请求: { link: '...' }
任务已添加到队列: xxx
开始处理文档: ...
[处理文档] 开始处理 submissionId: ...
[处理文档] 状态已更新为 processing
[处理文档] 开始获取飞书文档内容...
```

**如果处理失败：**
```
[处理文档] 处理失败: ...
错误堆栈: ...
```

**如果处理成功：**
```
[处理文档] 文档已保存到数据库，ID: xxx
[处理文档] 处理完成，文档ID: xxx
文档处理完成: ...
```

### 第三步：根据状态处理

#### 情况 1：状态是 `pending` 或 `processing`
**说明**：文档还在处理中，需要等待

**解决方案**：
- 等待 30-60 秒
- 查看后端控制台是否有处理日志
- 如果长时间没有进展，可能是队列处理卡住了

#### 情况 2：状态是 `failed`
**说明**：文档处理失败

**可能原因**：
1. **飞书文档无法访问**
   - 文档需要公开权限
   - 链接格式不正确
   - 网络问题

2. **AI API 调用失败**
   - DeepSeek API Key 无效或过期
   - API 额度用完
   - 网络问题

3. **其他错误**
   - 查看 `error` 字段的具体错误信息

**解决方案**：
- 查看 `error` 字段了解具体错误
- 检查 DeepSeek API Key 是否正确
- 尝试提交一个公开的飞书文档链接

#### 情况 3：状态是 `completed` 但 Document 表为空
**说明**：处理标记为完成，但文档没有保存

**可能原因**：数据库保存失败

**解决方案**：
- 查看后端控制台的错误日志
- 检查数据库连接

## 常见问题

### Q: 为什么提交成功但没有文档？
A: 文档处理是异步的，需要时间。提交成功只是表示任务已加入队列，实际处理需要：
- 爬取飞书文档（几秒到几十秒）
- 调用 AI API（几秒到十几秒）
- 保存到数据库（几秒）

总共可能需要 30-60 秒。

### Q: 如何知道文档是否处理成功？
A: 
1. 查看后端控制台的日志
2. 运行 `backend/详细诊断.bat` 查看状态
3. 前端刷新页面查看文档列表

### Q: 文档处理失败怎么办？
A:
1. 查看 `error` 字段了解具体错误
2. 检查飞书文档链接是否可访问（需要公开权限）
3. 检查 DeepSeek API Key 是否正确
4. 查看后端控制台的详细错误日志

## 下一步

1. **运行 `backend/详细诊断.bat`**
2. **查看后端控制台的日志**
3. **把结果告诉我**：
   - DocumentSubmission 表的状态是什么？
   - 如果有错误，error 字段显示什么？
   - 后端控制台显示了什么日志？


