# 重新创建数据库

## 问题说明

在 PostgreSQL 中看不到 `feihub` 数据库，说明：
1. 数据库可能没有真正创建成功
2. 或者宝塔面板的数据库管理有问题

---

## 🔍 第一步：在宝塔面板检查数据库

1. **打开宝塔面板**
   - 访问：`http://你的服务器IP:8888`

2. **检查数据库列表**
   - 点击左侧 **"数据库"** → **"PostgreSQL"**
   - 查看是否有 `feihub` 数据库

3. **如果存在但看不到**
   - 可能是显示问题，尝试刷新页面
   - 或者数据库创建失败但没有提示

---

## 🔧 解决方案：重新创建数据库

### 步骤 1：删除旧数据库（如果存在）

1. **在宝塔面板删除**
   - 数据库 → PostgreSQL
   - 如果看到 `feihub`，点击右侧 **"删除"**
   - 确认删除

2. **或者在终端删除**
   ```bash
   # 删除数据库（如果存在）
   sudo -u postgres /www/server/pgsql/bin/psql -c "DROP DATABASE IF EXISTS feihub;"
   ```

---

### 步骤 2：重新创建数据库

**在宝塔面板创建：**

1. 点击左侧 **"数据库"** → **"PostgreSQL"**
2. 点击 **"添加数据库"**
3. 填写：
   - **数据库名**：`feihub`
   - **用户名**：`feihub_user`
   - **密码**：`JYH6RfxKSNXTR7kN`（或设置一个新密码）
4. 点击 **"提交"**
5. **等待创建完成**（可能需要几秒钟）

---

### 步骤 3：验证数据库创建成功

在宝塔终端执行：

```bash
# 列出所有数据库
sudo -u postgres /www/server/pgsql/bin/psql -l
```

**应该能看到 `feihub` 数据库。**

---

### 步骤 4：更新 .env 文件

在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/backend`
2. 编辑 `.env` 文件
3. 确保 `DATABASE_URL` 使用正确的密码：

```env
DATABASE_URL=postgresql://feihub_user:JYH6RfxKSNXTR7kN@localhost:5432/feihub?schema=public
```

**如果重新创建时使用了新密码，记得更新这里。**

---

### 步骤 5：授予权限

在宝塔终端执行：

```bash
# 授予权限
sudo -u postgres /www/server/pgsql/bin/psql <<EOF
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
\c feihub
GRANT ALL ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;
\q
EOF
```

---

### 步骤 6：验证连接

```bash
# 测试 feihub_user 是否可以连接
cd /www/wwwroot/feihub/backend
psql -h localhost -U feihub_user -d feihub -c "SELECT 1;"
```

**如果成功，应该显示 `1`。**

---

### 步骤 7：运行数据库迁移

```bash
cd /www/wwwroot/feihub/backend
npx prisma migrate deploy
```

---

## 🆘 如果宝塔面板创建失败

### 方法 A：在终端手动创建

在宝塔终端执行：

```bash
# 1. 创建数据库
sudo -u postgres /www/server/pgsql/bin/psql <<EOF
CREATE DATABASE feihub;
CREATE USER feihub_user WITH PASSWORD 'JYH6RfxKSNXTR7kN';
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
\c feihub
GRANT ALL ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;
\q
EOF

# 2. 验证创建成功
sudo -u postgres /www/server/pgsql/bin/psql -l | grep feihub

# 3. 验证连接
cd /www/wwwroot/feihub/backend
psql -h localhost -U feihub_user -d feihub -c "SELECT 1;"
```

---

## 📋 完整操作流程

### 1. 在宝塔面板重新创建数据库
- 数据库 → PostgreSQL → 添加数据库
- 数据库名：`feihub`
- 用户名：`feihub_user`
- 密码：`JYH6RfxKSNXTR7kN`

### 2. 验证数据库存在（在终端）
```bash
sudo -u postgres /www/server/pgsql/bin/psql -l | grep feihub
```

### 3. 更新 .env 文件（在宝塔文件管理器）
- 确保 `DATABASE_URL` 使用正确的密码

### 4. 授予权限（在终端）
```bash
sudo -u postgres /www/server/pgsql/bin/psql <<EOF
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
\c feihub
GRANT ALL ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;
\q
EOF
```

### 5. 运行迁移（在终端）
```bash
cd /www/wwwroot/feihub/backend
npx prisma migrate deploy
```

---

## ✅ 成功标志

1. **验证数据库存在**：
   ```bash
   sudo -u postgres /www/server/pgsql/bin/psql -l | grep feihub
   ```
   应该显示 `feihub` 数据库。

2. **运行迁移成功**：
   ```
   All migrations have been successfully applied.
   ```

---

## 🎯 推荐操作

**先尝试在宝塔面板重新创建数据库**，如果还是不行，再使用终端手动创建。

告诉我结果，我们继续。


