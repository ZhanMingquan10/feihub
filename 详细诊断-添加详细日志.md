# è¯¦ç»†è¯Šæ–­ - æ·»åŠ è¯¦ç»†æ—¥å¿—æŸ¥çœ‹æ‰€æœ‰æå–å†…å®¹

## ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

### ç¬¬ä¸€æ­¥ï¼šæ·»åŠ è¯¦ç»†æ—¥å¿—åˆ°ä»£ç ä¸­

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåœ¨å†…å®¹æå–çš„å…³é”®ä½ç½®æ·»åŠ è¯¦ç»†æ—¥å¿—ï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

# å¤‡ä»½
cp feishu-puppeteer.ts feishu-puppeteer.ts.bak16

# æ·»åŠ è¯¦ç»†æ—¥å¿—
python3 << 'PYEOF'
with open('feishu-puppeteer.ts', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# åœ¨ page.evaluate ä¸­ï¼Œä¸ºæ¯ä¸ªé€‰æ‹©å™¨æ·»åŠ æ—¥å¿—
for i, line in enumerate(lines):
    if 'for (const selector of selectors)' in line:
        # åœ¨å¾ªç¯å†…æ·»åŠ æ—¥å¿—
        indent = len(line) - len(line.lstrip())
        indent_str = ' ' * indent
        
        # æŸ¥æ‰¾å¾ªç¯å†…çš„å…ƒç´ å¤„ç†éƒ¨åˆ†
        for j in range(i+1, min(i+100, len(lines))):
            if 'const elements = document.querySelectorAll(selector)' in lines[j]:
                # åœ¨è¿™è¡Œåæ·»åŠ æ—¥å¿—
                el_indent = len(lines[j]) - len(lines[j].lstrip())
                el_indent_str = ' ' * el_indent
                lines.insert(j+1, f"{el_indent_str}console.log(`[è°ƒè¯•] é€‰æ‹©å™¨ "${selector}" æ‰¾åˆ° ${elements.length} ä¸ªå…ƒç´ `);\n")
                print(f"âœ… åœ¨ç¬¬ {j+1} è¡Œåæ·»åŠ é€‰æ‹©å™¨æ—¥å¿—")
            
            if 'let text = clone.innerText' in lines[j]:
                # åœ¨æå–æ–‡æœ¬åæ·»åŠ æ—¥å¿—
                text_indent = len(lines[j]) - len(lines[j].lstrip())
                text_indent_str = ' ' * text_indent
                lines.insert(j+1, f"{text_indent_str}console.log(`[è°ƒè¯•] æå–çš„æ–‡æœ¬ï¼ˆå‰200å­—ç¬¦ï¼‰: "${text.substring(0, 200)}"`);\n")
                lines.insert(j+2, f"{text_indent_str}console.log(`[è°ƒè¯•] æ–‡æœ¬é•¿åº¦: ${text.length}, åŒ…å«ä¸­æ–‡: ${/[\\u4e00-\\u9fa5]/.test(text)}, åŒ…å« Help Center: ${text.includes('Help Center')}`);\n")
                print(f"âœ… åœ¨ç¬¬ {j+1} è¡Œåæ·»åŠ æ–‡æœ¬æå–æ—¥å¿—")
                break
        break

with open('feishu-puppeteer.ts', 'w', encoding='utf-8') as f:
    f.writelines(lines)
print("âœ… å·²æ·»åŠ è¯¦ç»†æ—¥å¿—")
PYEOF

# é‡æ–°æ„å»º
cd /www/wwwroot/feihub/backend
npm run build
pm2 restart feihub-backend
```

### ç¬¬äºŒæ­¥ï¼šæ‰§è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
cd /www/wwwroot/feihub/backend

# åˆ›å»ºæµ‹è¯•è„šæœ¬
cat > test_detailed.js << 'JSEOF'
const { fetchFeishuDocument } = require('./dist/lib/feishu');
const link = 'https://ai.feishu.cn/docx/VGoXdFXmooasHUxsZ0icAD2WnGe';
fetchFeishuDocument(link).then(r => {
  console.log('æ ‡é¢˜:', r.title);
  console.log('å†…å®¹é•¿åº¦:', r.content.length);
  console.log('å†…å®¹:', r.content);
}).catch(e => console.error(e));
JSEOF

# æ‰§è¡Œæµ‹è¯•
node test_detailed.js

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs feihub-backend --lines 500 --nostream | grep -E "\[è°ƒè¯•\]|\[Puppeteer\]" | tail -100
```

---

## ğŸ“ æˆ–è€…æ›´ç®€å•çš„æ–¹æ³•ï¼šç›´æ¥æŸ¥çœ‹é¡µé¢ HTML

```bash
cd /www/wwwroot/feihub/backend

# åˆ›å»ºä¸€ä¸ªè„šæœ¬ï¼Œä¿å­˜é¡µé¢ HTML åˆ°æ–‡ä»¶
cat > save_html.js << 'JSEOF'
const puppeteer = require('puppeteer-core');
const fs = require('fs');

(async () => {
  const browser = await puppeteer.launch({
    executablePath: process.env.CHROME_PATH || '/usr/bin/chromium-browser',
    headless: true,
    args: ['--no-sandbox', '--disable-setuid-sandbox']
  });
  const page = await browser.newPage();
  await page.goto('https://ai.feishu.cn/docx/VGoXdFXmooasHUxsZ0icAD2WnGe', { waitUntil: 'networkidle2' });
  await new Promise(resolve => setTimeout(resolve, 10000));
  const html = await page.content();
  fs.writeFileSync('/tmp/feishu_page.html', html);
  console.log('âœ… HTML å·²ä¿å­˜åˆ° /tmp/feishu_page.html');
  await browser.close();
})();
JSEOF

node save_html.js

# æŸ¥çœ‹ HTML æ–‡ä»¶
echo "æ–‡ä»¶å¤§å°:"
ls -lh /tmp/feishu_page.html

# æŸ¥çœ‹åŒ…å«"å—¨ï¼Œä½ å¥½"çš„éƒ¨åˆ†
grep -o -A 10 -B 10 "å—¨ï¼Œä½ å¥½" /tmp/feishu_page.html | head -30
```

---

æ¨èä½¿ç”¨ç¬¬äºŒä¸ªæ–¹æ³•ï¼ˆä¿å­˜ HTMLï¼‰ï¼Œè¿™æ ·å¯ä»¥æŸ¥çœ‹é¡µé¢çš„å®Œæ•´ç»“æ„ï¼Œæ‰¾å‡ºæ­£æ–‡åœ¨å“ªé‡Œã€‚

