# FeiHub 部署检查清单

## ✅ 已完成
- [x] 代码已推送到 GitHub
- [x] 代码已克隆到服务器：`/www/wwwroot/feihub`

---

## 📋 下一步检查清单

### 1. 验证代码已克隆成功

在宝塔终端执行：

```bash
cd /www/wwwroot/feihub
ls -la
```

应该能看到项目文件（`backend/`, `src/`, `package.json` 等）

---

### 2. 检查必要软件是否已安装

在宝塔终端执行：

```bash
# 检查 Node.js
node --version
npm --version

# 检查 PostgreSQL
psql --version

# 检查 Redis
redis-cli --version

# 检查 PM2
pm2 --version
```

**如果缺少某个软件，参考 `宝塔面板套件安装指南.md` 安装**

---

### 3. 创建数据库

1. 在宝塔面板，点击左侧 **"数据库"** → **"PostgreSQL"**
2. 点击 **"添加数据库"**
3. 填写：
   - **数据库名**：`feihub`
   - **用户名**：`feihub_user`
   - **密码**：设置一个强密码（**记住这个密码！**）
4. 点击 **"提交"**

**记录数据库信息：**
- 数据库地址：`localhost` 或 `127.0.0.1`
- 端口：`5432`
- 数据库名：`feihub`
- 用户名：`feihub_user`
- 密码：你刚才设置的密码

---

### 4. 配置后端环境变量

1. 在宝塔文件管理器中，进入 `/www/wwwroot/feihub/backend`
2. 创建 `.env` 文件（如果不存在）
3. 编辑 `.env` 文件，添加以下内容（**替换为你的实际值**）：

```env
# 服务器配置
PORT=4000
NODE_ENV=production

# 数据库配置（使用第三步创建的数据库信息）
DATABASE_URL=postgresql://feihub_user:你的数据库密码@localhost:5432/feihub

# Redis 配置
REDIS_URL=redis://localhost:6379

# AI API 配置（必须配置其中一个）
DEEPSEEK_API_KEY=your_deepseek_api_key
# 或
# OPENAI_API_KEY=your_openai_api_key

# CORS 配置（你的域名）
CORS_ORIGIN=https://feihub.top

# 客服图片URL（可选）
# CUSTOMER_SERVICE_IMAGE_URL=https://your-cdn.com/kefu.png
```

**重要提示：**
- 替换 `你的数据库密码` 为第三步设置的密码
- 替换 `your_deepseek_api_key` 为你的 DeepSeek API Key
- 如果使用 OpenAI，取消注释 `OPENAI_API_KEY` 并注释掉 `DEEPSEEK_API_KEY`

---

### 5. 安装后端依赖并运行迁移

在宝塔终端执行：

```bash
cd /www/wwwroot/feihub/backend

# 安装依赖
npm install --production

# 生成 Prisma Client
npx prisma generate

# 运行数据库迁移
npx prisma migrate deploy
```

---

### 6. 构建后端

```bash
npm run build
```

---

### 7. 启动后端服务

```bash
# 创建日志目录
mkdir -p logs

# 启动服务
pm2 start ecosystem.config.js

# 保存配置
pm2 save

# 设置开机自启（执行后会显示一行命令，复制并执行它）
pm2 startup
```

---

### 8. 验证后端运行

```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs feihub-backend
```

**应该看到：**
- `pm2 status` 显示 `feihub-backend` 状态为 `online`
- 日志中没有错误信息

---

### 9. 配置前端

#### 9.1 安装前端依赖

```bash
cd /www/wwwroot/feihub
npm install
```

#### 9.2 创建前端环境变量

在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub`
2. 创建 `.env.production` 文件
3. 添加以下内容：

```env
VITE_API_BASE=https://feihub.top/api
# 如果客服图片使用CDN，取消下面的注释
# VITE_CUSTOMER_SERVICE_IMAGE_URL=https://your-cdn.com/kefu.png
```

#### 9.3 构建前端

```bash
npm run build
```

#### 9.4 上传客服图片

在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/dist`
2. 上传 `kefu.png` 文件到这个目录

---

### 10. 配置 Nginx

1. 在宝塔面板，点击左侧 **"网站"**
2. 点击 **"添加站点"**
3. 填写：
   - **域名**：`feihub.top`（和 `www.feihub.top`）
   - **根目录**：`/www/wwwroot/feihub/dist`
   - **PHP版本**：纯静态
4. 点击 **"提交"**

5. **配置反向代理**（用于后端 API）：
   - 点击站点右侧 **"设置"**
   - 点击 **"反向代理"** → **"添加反向代理"**
   - 填写：
     - **代理名称**：`api`
     - **目标URL**：`http://127.0.0.1:4000`
     - **发送域名**：`$host`
   - 点击 **"提交"**

6. **配置 SSL 证书**（推荐）：
   - 点击站点右侧 **"设置"**
   - 点击 **"SSL"** → **"Let's Encrypt"**
   - 勾选域名，点击 **"申请"**
   - 申请成功后，点击 **"强制HTTPS"**

---

### 11. 验证部署

1. **访问网站**：`https://feihub.top`
2. **测试功能**：
   - 搜索文档
   - 分享文档
   - 查看文档详情

---

## 🔄 后续更新代码

当你在本地修改代码后：

1. **本地推送**：
   ```bash
   git add .
   git commit -m "描述修改内容"
   git push
   ```

2. **服务器更新**：
   ```bash
   cd /www/wwwroot/feihub
   git pull
   
   # 更新后端
   cd backend
   npm install --production
   npm run build
   pm2 restart feihub-backend
   
   # 更新前端
   cd ..
   npm install
   npm run build
   ```

---

## 🆘 遇到问题？

### 后端启动失败

```bash
# 查看详细日志
pm2 logs feihub-backend --lines 50

# 检查端口是否被占用
netstat -tlnp | grep 4000
```

### 数据库连接失败

- 检查 `.env` 文件中的 `DATABASE_URL` 是否正确
- 检查数据库是否已创建
- 检查 PostgreSQL 服务是否运行

### 前端构建失败

```bash
# 查看详细错误
npm run build --verbose
```

---

## 📝 重要提示

1. **环境变量**：`.env` 文件包含敏感信息，不要上传到 GitHub
2. **数据库密码**：记住你设置的数据库密码
3. **API Key**：确保在 `.env` 中配置了 AI API Key
4. **客服图片**：记得上传 `kefu.png` 到 `dist` 目录


