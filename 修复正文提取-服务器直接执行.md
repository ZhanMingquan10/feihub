# 修复正文提取问题 - 服务器直接执行

## 🚀 一键修复（推荐）

在服务器上执行以下命令（复制粘贴即可）：

```bash
cd /www/wwwroot/feihub/backend/src/lib && \
python3 << 'PYEOF'
import os
import re
import glob

def fix_file(file_path):
    print(f"\n处理文件: {file_path}")
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    original = content
    
    # 修复1: 在 bodyText 提取后添加清理
    if 'bodyText' in content:
        pattern = r'(let\s+bodyText\s*=\s*\(body\.(?:innerText|textContent)[^;]+\.trim\(\);)'
        def add_cleanup(match):
            return match.group(1) + '''
        
        // 移除导航栏和帮助中心文本
        bodyText = bodyText
            .replace(/Help Center[^\\n]*/gi, '')
            .replace(/Keyboard Shortcuts[^\\n]*/gi, '')
            .replace(/Token Limit[^\\n]*/gi, '')
            .replace(/快捷键[^\\n]*/gi, '')
            .replace(/\\s+/g, ' ')
            .trim();
        
        // 验证内容有效性
        if (bodyText.length < 100 || (!/[\\u4e00-\\u9fa5]/.test(bodyText) && bodyText.length < 200)) {
            bodyText = '';
        }'''
        content = re.sub(pattern, add_cleanup, content)
    
    # 修复2: 在返回 bodyText 前添加检查
    pattern2 = r'(return\s+bodyText;)'
    def add_check(match):
        return '''// 最终检查：排除导航栏内容
        if (bodyText && (
            bodyText.includes('Help Center') || 
            bodyText.includes('Keyboard Shortcuts') ||
            bodyText.includes('Token Limit')
        )) {
            bodyText = '';
        }
        return bodyText;'''
    content = re.sub(pattern2, add_check, content)
    
    # 修复3: 在循环中提取文本后添加过滤
    pattern3 = r'(const\s+text\s*=\s*(?:cloned|element)\.(?:innerText|textContent)\s*\|\|\s*[^;]+;\s*)(?=\s*const\s+cleanText|if\s*\(cleanText|if\s*\([^)]*text[^)]*length)'
    def add_filter(match):
        return match.group(1) + '''
            // 过滤导航栏内容
            if (text && (
                text.includes('Help Center') || 
                text.includes('Keyboard Shortcuts') ||
                text.includes('Token Limit') ||
                text.includes('快捷键')
            )) {
              continue;
            }
            '''
    content = re.sub(pattern3, add_filter, content, flags=re.MULTILINE)
    
    if content != original:
        # 备份
        with open(file_path + '.bak', 'w', encoding='utf-8') as f:
            f.write(original)
        # 保存
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"  ✅ 已修复: {file_path}")
        return True
    else:
        print(f"  ⚠️  未找到需要修改的代码")
        return False

# 处理所有 feishu*.ts 文件
files = glob.glob('feishu*.ts')
fixed = 0
for f in files:
    if fix_file(f):
        fixed += 1

print(f"\n修复完成！共修复 {fixed} 个文件")
PYEOF

# 重新构建
cd /www/wwwroot/feihub/backend && \
npm run build && \
pm2 restart feihub-backend && \
echo "✅✅✅ 修复完成！请重新测试文档提取"
```

---

## 📝 如果上面的命令太长，分步执行：

### 第一步：修复文件

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 创建修复脚本
cat > fix_content.py << 'PYEOF'
import os
import re
import glob

def fix_file(file_path):
    print(f"\n处理: {file_path}")
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    original = content
    
    # 在 bodyText 提取后添加清理
    if 'bodyText' in content:
        pattern = r'(let\s+bodyText\s*=\s*\(body\.(?:innerText|textContent)[^;]+\.trim\(\);)'
        def add_cleanup(match):
            return match.group(1) + '''
        
        bodyText = bodyText
            .replace(/Help Center[^\\n]*/gi, '')
            .replace(/Keyboard Shortcuts[^\\n]*/gi, '')
            .replace(/Token Limit[^\\n]*/gi, '')
            .replace(/快捷键[^\\n]*/gi, '')
            .replace(/\\s+/g, ' ')
            .trim();
        
        if (bodyText.length < 100 || (!/[\\u4e00-\\u9fa5]/.test(bodyText) && bodyText.length < 200)) {
            bodyText = '';
        }'''
        content = re.sub(pattern, add_cleanup, content)
    
    # 在返回前添加检查
    pattern2 = r'(return\s+bodyText;)'
    def add_check(match):
        return '''if (bodyText && (bodyText.includes('Help Center') || bodyText.includes('Keyboard Shortcuts') || bodyText.includes('Token Limit'))) {
            bodyText = '';
        }
        return bodyText;'''
    content = re.sub(pattern2, add_check, content)
    
    if content != original:
        with open(file_path + '.bak', 'w', encoding='utf-8') as f:
            f.write(original)
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"  ✅ 已修复")
        return True
    return False

for f in glob.glob('feishu*.ts'):
    fix_file(f)
PYEOF

# 执行修复
python3 fix_content.py
```

### 第二步：重新构建和重启

```bash
cd /www/wwwroot/feihub/backend
npm run build
pm2 restart feihub-backend
```

---

## ✅ 验证

修复后，重新测试文档提取：
1. 访问网站
2. 提交链接：`https://ai.feishu.cn/docx/VGoXdFXmooasHUxsZ0icAD2WnGe`
3. 检查正文是否显示："嗨，你好，我是安七。应届毕业生，1年双百万，主攻ai+写作。"
4. 确认不再显示 "Help Center"、"Keyboard Shortcuts"、"Token Limit"

---

推荐使用**一键修复**命令，直接复制粘贴执行即可。

