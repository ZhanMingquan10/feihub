# 执行添加等待日期元素代码

## 🚀 在服务器上执行

在宝塔终端执行：

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 备份
cp feishu-puppeteer.ts feishu-puppeteer.ts.backup3

# 在第165行之后插入等待日期元素的代码
sed -i '165a\
\
    // 额外等待，确保日期元素也加载完成（飞书的日期元素可能需要更长时间）\
    console.log(`[Puppeteer] 额外等待，确保日期元素加载完成...`);\
\
    // 等待日期元素出现（最多等待10秒）\
    try {\
      await page.waitForSelector(".doc-info-time-item", { timeout: 10000 });\
      console.log(`[Puppeteer] ✅ 找到日期元素 .doc-info-time-item`);\
\
      // 立即提取日期元素的内容，用于调试\
      const dateElementText = await page.evaluate(() => {\
        const el = document.querySelector(".doc-info-time-item");\
        if (el) {\
          return (el.innerText || el.textContent || "").trim();\
        }\
        return null;\
      });\
      console.log(`[Puppeteer] 📅 日期元素内容: "${dateElementText}"`);\
    } catch (e) {\
      console.warn(`[Puppeteer] ⚠️ 未找到日期元素 .doc-info-time-item，继续提取...`);\
    }\
\
    // 再等待3秒，确保所有内容完全渲染\
    await new Promise(resolve => setTimeout(resolve, 3000));
' feishu-puppeteer.ts

echo "✅ 代码已添加"

# 验证
echo ""
echo "验证添加结果："
grep -n "额外等待，确保日期元素加载完成" feishu-puppeteer.ts
grep -n "找到日期元素" feishu-puppeteer.ts
```

---

## ✅ 如果添加成功，应该看到：

```
✅ 代码已添加

验证添加结果：
166:    console.log(`[Puppeteer] 额外等待，确保日期元素加载完成...`);
170:      console.log(`[Puppeteer] ✅ 找到日期元素 .doc-info-time-item`);
```

---

## 🚀 然后重新构建和部署

```bash
cd /www/wwwroot/feihub/backend

# 重新构建
npm run build

# 检查构建是否成功
if [ $? -eq 0 ]; then
    echo "✅ 构建成功"
    
    # 完全重启 PM2
    pm2 stop feihub-backend
    pm2 delete feihub-backend
    pm2 start npm --name feihub-backend -- run start
    
    # 等待启动
    sleep 5
    
    echo "✅ 部署完成"
else
    echo "❌ 构建失败，请检查错误信息"
    npm run build 2>&1 | tail -20
fi
```

---

## 🧪 测试

提交测试文档后，应该能看到完整的日期提取日志。

