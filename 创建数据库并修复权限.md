# 创建数据库并修复权限

## 问题说明

错误：`database "feihub" does not exist`

这说明数据库还没有创建，需要先在宝塔面板创建数据库。

---

## 🔧 解决方案

### 步骤 1：在宝塔面板创建数据库

1. **打开宝塔面板**
   - 访问：`http://你的服务器IP:8888`

2. **创建数据库**
   - 点击左侧 **"数据库"** → **"PostgreSQL"**
   - 点击 **"添加数据库"**
   - 填写：
     - **数据库名**：`feihub`
     - **用户名**：`feihub_user`
     - **密码**：设置一个强密码（**记住这个密码！**）
   - 点击 **"提交"**

3. **记录数据库信息**
   - 数据库名：`feihub`
   - 用户名：`feihub_user`
   - 密码：你刚才设置的密码

---

### 步骤 2：更新 .env 文件

在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/backend`
2. 编辑 `.env` 文件
3. 确保 `DATABASE_URL` 使用正确的密码：

```env
DATABASE_URL=postgresql://feihub_user:你的数据库密码@localhost:5432/feihub?schema=public
```

**替换**：`你的数据库密码` → 步骤 1 中设置的密码

---

### 步骤 3：授予权限（可选，但推荐）

在宝塔终端执行：

```bash
# 授予权限（确保 feihub_user 有完整权限）
sudo -u postgres /www/server/pgsql/bin/psql <<EOF
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
\c feihub
GRANT ALL ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;
\q
EOF
```

---

### 步骤 4：验证数据库创建成功

```bash
# 测试连接
cd /www/wwwroot/feihub/backend
psql -h localhost -U feihub_user -d feihub -c "SELECT version();"
```

如果成功，应该显示 PostgreSQL 版本信息。

---

### 步骤 5：运行数据库迁移

```bash
cd /www/wwwroot/feihub/backend
npx prisma migrate deploy
```

---

## 📋 完整操作流程

### 1. 在宝塔面板创建数据库
- 数据库 → PostgreSQL → 添加数据库
- 数据库名：`feihub`
- 用户名：`feihub_user`
- 密码：设置并记住

### 2. 更新 .env 文件
- 文件管理器 → `/www/wwwroot/feihub/backend/.env`
- 更新 `DATABASE_URL` 中的密码

### 3. 授予权限（在终端执行）
```bash
sudo -u postgres /www/server/pgsql/bin/psql <<EOF
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
\c feihub
GRANT ALL ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;
\q
EOF
```

### 4. 运行迁移（在终端执行）
```bash
cd /www/wwwroot/feihub/backend
npx prisma migrate deploy
```

---

## ✅ 成功标志

运行 `npx prisma migrate deploy` 后，应该看到：

```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "feihub", schema "public" at "localhost:5432"

Applying migration `20251128025133_add_content_field`
Applying migration `20251128054005_add_ai_structured_summary`

All migrations have been successfully applied.
```

---

## 🆘 如果创建数据库时出错

### 检查 PostgreSQL 服务

```bash
# 检查服务状态
ps aux | grep postgres | grep -v grep

# 检查端口
netstat -tlnp | grep 5432
```

### 在宝塔面板检查

1. 软件商店 → PostgreSQL → 设置
2. 确认服务状态是 **"运行中"**
3. 如果没有运行，点击 **"启动"**

---

## 📝 注意事项

1. **数据库密码**：记住你设置的密码，需要更新到 `.env` 文件
2. **权限问题**：如果迁移时还是报权限错误，执行步骤 3 授予权限
3. **全新数据库**：这样创建的数据库是全新的，没有任何测试数据

---

## 🎯 下一步

完成以上步骤后，继续：
1. 构建后端：`npm run build`
2. 启动后端：`pm2 start ecosystem.config.js`
3. 构建前端：`cd .. && npm install && npm run build`
4. 配置 Nginx


