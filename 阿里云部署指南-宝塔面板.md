# FeiHub 阿里云部署指南（宝塔面板版）

## 🎯 服务器配置选择

### 推荐配置
- **应用镜像**：✅ **宝塔Linux面板**（强烈推荐）
- **系统**：CentOS 7.9 或 Ubuntu 20.04
- **配置**：2核4G内存，40GB SSD硬盘，3-5Mbps带宽
- **地域**：选择离用户最近的地域

### 为什么选择宝塔面板？
- ✅ 图形界面，操作简单
- ✅ 一键安装 Node.js、Nginx、数据库
- ✅ 方便管理文件、配置SSL证书
- ✅ 适合不熟悉Linux命令的用户

---

## 📋 部署前准备

### 1. 购买服务器后的信息
- 服务器公网IP
- root密码（或SSH密钥）
- 宝塔面板登录地址和账号密码（首次登录会显示）

### 2. 域名准备（可选但推荐）
- 购买域名（如：feihub.com）
- 在阿里云域名控制台解析到服务器IP

---

## 🚀 部署步骤

### 第一步：登录宝塔面板

1. **获取宝塔面板信息**
   - 在阿里云控制台，找到你的服务器
   - 点击"远程连接"，使用"Workbench远程连接"
   - 在终端执行：`bt default` 查看面板地址和账号密码

2. **访问宝塔面板**
   - 在浏览器打开显示的地址（如：`http://your-ip:8888`）
   - 使用显示的账号密码登录

3. **安装必要软件**
   - 登录后，宝塔会提示安装LNMP或LAMP
   - 选择"LNMP"（Linux + Nginx + MySQL + PHP）
   - 但我们需要的是：
     - ✅ Nginx（必须）
     - ✅ Node.js（必须）
     - ✅ PostgreSQL（必须）
     - ✅ Redis（必须）
     - ❌ MySQL（不需要，但可以保留）
     - ❌ PHP（不需要）

### 第二步：安装 Node.js

1. **在宝塔面板中安装 Node.js**
   - 点击左侧"软件商店"
   - 搜索"Node.js版本管理器"
   - 点击"安装"，选择 Node.js 18.x 版本
   - 等待安装完成

2. **验证安装**
   - 点击"终端"
   - 执行：`node -v` 和 `npm -v`
   - 应该显示版本号

3. **安装 PM2（进程管理器）**
   - 在终端执行：`npm install -g pm2`

### 第三步：安装 PostgreSQL

1. **在宝塔面板中安装 PostgreSQL**
   - 点击"软件商店"
   - 搜索"PostgreSQL"
   - 点击"安装"，选择最新版本（建议 15.x）
   - 等待安装完成

2. **配置数据库**
   - 点击"数据库" → "PostgreSQL"
   - 点击"添加数据库"
   - 数据库名：`feihub`
   - 用户名：`feihub_user`
   - 密码：设置一个强密码（记住这个密码！）
   - 点击"提交"

3. **获取数据库连接信息**
   - 数据库地址：`localhost` 或 `127.0.0.1`
   - 端口：`5432`（默认）
   - 数据库名：`feihub`
   - 用户名：`feihub_user`
   - 密码：你刚才设置的密码

### 第四步：安装 Redis

1. **在宝塔面板中安装 Redis**
   - 点击"软件商店"
   - 搜索"Redis"
   - 点击"安装"，选择最新版本
   - 等待安装完成

2. **启动 Redis**
   - 安装后会自动启动
   - 可以在"服务"中查看 Redis 状态

### 第五步：上传项目代码

#### 方式一：使用宝塔文件管理器（推荐）

1. **创建项目目录**
   - 点击"文件"
   - 进入 `/www/wwwroot/`
   - 创建文件夹：`feihub`
   - 进入 `feihub` 文件夹

2. **上传代码**
   - 在本地将项目打包为 zip 文件
   - 在宝塔文件管理器中，点击"上传"
   - 选择 zip 文件上传
   - 上传完成后，右键 zip 文件 → "解压"

#### 方式二：使用 Git（如果代码在Git仓库）

1. **在终端执行**
   ```bash
   cd /www/wwwroot/
   git clone https://your-repo-url.git feihub
   cd feihub
   ```

### 第六步：配置后端

1. **安装后端依赖**
   - 在宝塔终端中执行：
   ```bash
   cd /www/wwwroot/feihub/backend
   npm install --production
   ```

2. **配置环境变量**
   - 在宝塔文件管理器中，进入 `/www/wwwroot/feihub/backend`
   - 创建或编辑 `.env` 文件
   - 添加以下内容：
   ```env
   # 服务器配置
   PORT=4000
   NODE_ENV=production

   # 数据库配置（使用第三步创建的数据库信息）
   DATABASE_URL=postgresql://feihub_user:你的数据库密码@localhost:5432/feihub

   # Redis 配置
   REDIS_URL=redis://localhost:6379

   # AI API 配置
   DEEPSEEK_API_KEY=your_deepseek_api_key
   # 或
   OPENAI_API_KEY=your_openai_api_key

   # CORS 配置（你的域名）
   CORS_ORIGIN=https://your-domain.com

   # 客服图片URL（如果使用CDN）
   CUSTOMER_SERVICE_IMAGE_URL=https://your-cdn.com/kefu.png
   ```

3. **运行数据库迁移**
   ```bash
   cd /www/wwwroot/feihub/backend
   npx prisma generate
   npx prisma migrate deploy
   ```

4. **构建后端**
   ```bash
   npm run build
   ```

5. **使用 PM2 启动后端**
   ```bash
   # 创建日志目录
   mkdir -p logs

   # 启动服务
   pm2 start ecosystem.config.js

   # 保存配置
   pm2 save

   # 设置开机自启
   pm2 startup
   ```

### 第七步：构建和部署前端

1. **安装前端依赖**
   ```bash
   cd /www/wwwroot/feihub
   npm install
   ```

2. **配置前端环境变量**
   - 在宝塔文件管理器中，进入 `/www/wwwroot/feihub`
   - 创建 `.env.production` 文件：
   ```env
   VITE_API_BASE=https://your-domain.com/api
   VITE_CUSTOMER_SERVICE_IMAGE_URL=https://your-cdn.com/kefu.png
   ```

3. **构建前端**
   ```bash
   npm run build
   ```

4. **上传客服图片**
   - 将 `kefu.png` 上传到 `/www/wwwroot/feihub/dist/` 目录
   - 或使用 CDN（推荐）

### 第八步：配置 Nginx

1. **在宝塔面板中配置网站**
   - 点击"网站" → "添加站点"
   - 域名：填写你的域名（如：`feihub.com`）
   - 根目录：`/www/wwwroot/feihub/dist`
   - PHP版本：纯静态
   - 点击"提交"

2. **配置反向代理**
   - 点击网站右侧"设置"
   - 点击"反向代理" → "添加反向代理"
   - 代理名称：`api`
   - 目标URL：`http://127.0.0.1:4000`
   - 发送域名：`$host`
   - 点击"提交"

3. **修改 Nginx 配置**
   - 点击"配置文件"
   - 找到 `location /` 部分，修改为：
   ```nginx
   location / {
       try_files $uri $uri/ /index.html;
   }
   ```
   - 在 `location /` 之前添加：
   ```nginx
   location /api {
       proxy_pass http://127.0.0.1:4000;
       proxy_http_version 1.1;
       proxy_set_header Upgrade $http_upgrade;
       proxy_set_header Connection 'upgrade';
       proxy_set_header Host $host;
       proxy_set_header X-Real-IP $remote_addr;
       proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
       proxy_set_header X-Forwarded-Proto $scheme;
       proxy_cache_bypass $http_upgrade;
   }
   ```
   - 点击"保存"

4. **重启 Nginx**
   - 点击"服务" → 找到 Nginx → 点击"重启"

### 第九步：配置 SSL 证书（HTTPS）

1. **在宝塔面板中申请 SSL 证书**
   - 点击网站右侧"设置"
   - 点击"SSL"
   - 选择"Let's Encrypt"
   - 勾选你的域名
   - 点击"申请"
   - 等待申请完成

2. **开启强制 HTTPS**
   - 申请成功后，点击"强制HTTPS"
   - 保存配置

### 第十步：配置防火墙

1. **在宝塔面板中配置防火墙**
   - 点击"安全"
   - 确保以下端口已开放：
     - ✅ 22（SSH）
     - ✅ 80（HTTP）
     - ✅ 443（HTTPS）
     - ✅ 8888（宝塔面板，建议修改）

2. **修改宝塔面板端口（安全建议）**
   - 点击"面板设置"
   - 修改"面板端口"为一个随机端口
   - 保存后，在阿里云安全组中开放新端口

---

## 🔧 常用操作

### 查看后端日志
```bash
pm2 logs feihub-backend
```

### 重启后端服务
```bash
pm2 restart feihub-backend
```

### 查看服务状态
```bash
pm2 status
```

### 备份数据库
- 在宝塔面板中，点击"数据库" → "PostgreSQL"
- 找到 `feihub` 数据库
- 点击"备份" → "立即备份"

---

## 🚨 常见问题

### 1. 无法访问网站
- 检查 Nginx 是否运行
- 检查防火墙是否开放 80/443 端口
- 检查域名解析是否正确

### 2. API 请求失败
- 检查后端服务是否运行：`pm2 status`
- 检查 Nginx 反向代理配置
- 查看后端日志：`pm2 logs feihub-backend`

### 3. 数据库连接失败
- 检查 PostgreSQL 是否运行
- 检查 `.env` 中的数据库连接信息
- 检查数据库用户权限

### 4. SSL 证书申请失败
- 确保域名已正确解析到服务器IP
- 确保 80 端口已开放
- 等待几分钟后重试

---

## ✅ 部署检查清单

- [ ] 服务器已购买并配置
- [ ] 宝塔面板已安装并登录
- [ ] Node.js 18+ 已安装
- [ ] PostgreSQL 已安装并创建数据库
- [ ] Redis 已安装并运行
- [ ] 项目代码已上传
- [ ] 后端环境变量已配置
- [ ] 数据库迁移已执行
- [ ] PM2 已启动后端服务
- [ ] 前端代码已构建
- [ ] Nginx 已配置
- [ ] SSL 证书已申请
- [ ] 防火墙已配置
- [ ] 域名已解析
- [ ] 测试访问正常

---

## 🎉 部署完成

部署完成后，访问 `https://your-domain.com` 即可使用 FeiHub！

---

## 📞 需要帮助？

如果遇到问题，请检查：
- 宝塔面板日志
- PM2 日志：`pm2 logs feihub-backend`
- Nginx 日志：在宝塔面板中查看网站日志


