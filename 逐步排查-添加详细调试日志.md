# é€æ­¥æ’æŸ¥å†…å®¹æå–é—®é¢˜

## ğŸ” ç¬¬ä¸€æ­¥ï¼šæŸ¥çœ‹ä»£ç ç»“æ„

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 1. æŸ¥çœ‹ page.evaluate çš„å®Œæ•´ç»“æ„
sed -n '414,500p' feishu-puppeteer.ts

# 2. æŸ¥çœ‹æå–æ–‡æœ¬çš„ä»£ç 
grep -B 5 -A 30 "let text = clone.innerText" feishu-puppeteer.ts | head -40

# 3. æŸ¥çœ‹éªŒè¯é€»è¾‘
grep -B 5 -A 10 "ç«‹å³éªŒè¯\|Help Center" feishu-puppeteer.ts | head -30

# 4. æŸ¥çœ‹ return text.trim() çš„ä½ç½®
grep -B 20 -A 5 "return text.trim()" feishu-puppeteer.ts | head -30

# 5. æŸ¥çœ‹ cheerio å¤‡ç”¨æ–¹æ¡ˆ
grep -A 50 "cheerio å¤‡ç”¨æ–¹æ¡ˆ" feishu-puppeteer.ts | head -60
```

---

## ğŸš€ ç¬¬äºŒæ­¥ï¼šæ·»åŠ è¯¦ç»†è°ƒè¯•æ—¥å¿—

åœ¨å…³é”®ä½ç½®æ·»åŠ æ—¥å¿—ï¼ŒæŸ¥çœ‹å®é™…æ‰§è¡Œæµç¨‹ï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

python3 << 'PYEOF'
with open('feishu-puppeteer.ts', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# åœ¨å…³é”®ä½ç½®æ·»åŠ è°ƒè¯•æ—¥å¿—
modifications = []

# 1. åœ¨é€‰æ‹©å™¨å¾ªç¯å¼€å§‹å¤„æ·»åŠ æ—¥å¿—
for i, line in enumerate(lines):
    if 'for (const selector of selectors)' in line:
        indent = len(line) - len(line.lstrip())
        indent_str = ' ' * indent
        lines.insert(i+1, f"{indent_str}console.log(`[è°ƒè¯•] å¼€å§‹éå†é€‰æ‹©å™¨ï¼Œå…± ${selectors.length} ä¸ª`);\n")
        modifications.append(f"âœ… åœ¨ç¬¬ {i+1} è¡Œåæ·»åŠ é€‰æ‹©å™¨æ—¥å¿—")
        break

# 2. åœ¨æå–æ–‡æœ¬åæ·»åŠ æ—¥å¿—
for i, line in enumerate(lines):
    if 'let text = clone.innerText' in line or 'let text = clone.textContent' in line:
        indent = len(line) - len(line.lstrip())
        indent_str = ' ' * indent
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰æ—¥å¿—
        has_log = any('[è°ƒè¯•]' in lines[j] and j > i and j < i+5 for j in range(len(lines)))
        if not has_log:
            lines.insert(i+1, f"{indent_str}console.log(`[è°ƒè¯•] æå–çš„æ–‡æœ¬é•¿åº¦: ${text.length}, å‰100å­—ç¬¦: "${text.substring(0, 100)}"`);\n")
            lines.insert(i+2, f"{indent_str}console.log(`[è°ƒè¯•] åŒ…å« Help Center: ${text.includes('Help Center')}, åŒ…å«ä¸­æ–‡: ${/[\\u4e00-\\u9fa5]/.test(text)}`);\n")
            modifications.append(f"âœ… åœ¨ç¬¬ {i+1} è¡Œåæ·»åŠ æ–‡æœ¬æå–æ—¥å¿—")
        break

# 3. åœ¨éªŒè¯ä»£ç å¤„æ·»åŠ æ—¥å¿—
for i, line in enumerate(lines):
    if 'ç«‹å³éªŒè¯' in line or ('Help Center' in line and 'includes' in line):
        # åœ¨éªŒè¯çš„ if è¯­å¥å†…æ·»åŠ æ—¥å¿—
        for j in range(i+1, min(i+15, len(lines))):
            if 'continue;' in lines[j] and 'è·³è¿‡' in lines[j]:
                indent = len(lines[j]) - len(lines[j].lstrip())
                indent_str = ' ' * indent
                lines.insert(j, f"{indent_str}console.log(`[è°ƒè¯•] âŒ è·³è¿‡å¯¼èˆªæ å†…å®¹ï¼Œæ–‡æœ¬: "${text.substring(0, 50)}"`);\n")
                modifications.append(f"âœ… åœ¨ç¬¬ {j+1} è¡Œå‰æ·»åŠ è·³è¿‡æ—¥å¿—")
                break
        break

# 4. åœ¨ return text.trim() å‰æ·»åŠ æ—¥å¿—
for i, line in enumerate(lines):
    if 'return text.trim()' in line and i > 400:
        indent = len(line) - len(line.lstrip())
        indent_str = ' ' * indent
        lines.insert(i, f"{indent_str}console.log(`[è°ƒè¯•] âœ… è¿”å›å†…å®¹ï¼Œé•¿åº¦: ${text.length}, å‰200å­—ç¬¦: "${text.substring(0, 200)}"`);\n")
        modifications.append(f"âœ… åœ¨ç¬¬ {i+1} è¡Œå‰æ·»åŠ è¿”å›æ—¥å¿—")
        break

if modifications:
    with open('feishu-puppeteer.ts.bak18', 'w', encoding='utf-8') as f:
        f.writelines(lines)
    with open('feishu-puppeteer.ts', 'w', encoding='utf-8') as f:
        f.writelines(lines)
    for mod in modifications:
        print(mod)
    print("âœ… å·²æ·»åŠ è°ƒè¯•æ—¥å¿—")
else:
    print("âš ï¸  æœªæ‰¾åˆ°éœ€è¦æ·»åŠ æ—¥å¿—çš„ä½ç½®")
PYEOF

# é‡æ–°æ„å»º
cd /www/wwwroot/feihub/backend
npm run build && pm2 restart feihub-backend
```

---

## ğŸ“ ç¬¬ä¸‰æ­¥ï¼šæ‰§è¡Œæµ‹è¯•å¹¶æŸ¥çœ‹æ—¥å¿—

```bash
cd /www/wwwroot/feihub/backend

# æ‰§è¡Œæµ‹è¯•
node test_extract.js

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
pm2 logs feihub-backend --lines 500 --nostream | grep -E "\[è°ƒè¯•\]|\[Puppeteer\]" | tail -100
```

---

è¯·å…ˆæ‰§è¡Œç¬¬ä¸€æ­¥ï¼ŒæŠŠè¾“å‡ºå‘ç»™æˆ‘ï¼Œæˆ‘ä¼šæ ¹æ®å®é™…ä»£ç ç»“æ„æä¾›ç²¾ç¡®çš„ä¿®å¤æ–¹æ¡ˆã€‚

