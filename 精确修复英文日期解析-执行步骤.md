# ç²¾ç¡®ä¿®å¤è‹±æ–‡æ—¥æœŸè§£æ - æ‰§è¡Œæ­¥éª¤

## ğŸš€ åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œ

åœ¨å®å¡”ç»ˆç«¯æ‰§è¡Œï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

# å¤‡ä»½
cp feishu-puppeteer.ts feishu-puppeteer.ts.backup7

# ä½¿ç”¨ Python è„šæœ¬ç²¾ç¡®ä¿®å¤
python3 << 'PYTHON_EOF'
file_path = '/www/wwwroot/feihub/backend/src/lib/feishu-puppeteer.ts'

with open(file_path, 'r', encoding='utf-8') as f:
    lines = f.readlines()

# æ‰¾åˆ°ç¬¬363è¡Œï¼ˆ"å‡†å¤‡è§£ææ—¥æœŸ"ï¼‰çš„ä½ç½®
for i in range(len(lines)):
    if i == 362 and 'å‡†å¤‡è§£ææ—¥æœŸ' in lines[i]:  # ç¬¬363è¡Œï¼ˆ0-based index 362ï¼‰
        indent = len(lines[i]) - len(lines[i].lstrip())
        
        # åˆ é™¤é‡å¤çš„æ—¥å¿—è¡Œï¼ˆç¬¬364è¡Œå’Œç¬¬368è¡Œï¼‰
        if i + 1 < len(lines) and 'å‡†å¤‡è§£ææ—¥æœŸ' in lines[i + 1]:
            lines.pop(i + 1)  # åˆ é™¤é‡å¤çš„ "å‡†å¤‡è§£ææ—¥æœŸ"
        
        # æ‰¾åˆ° parseChineseDate è°ƒç”¨
        parse_idx = i + 1
        while parse_idx < len(lines) and 'parseChineseDate' not in lines[parse_idx]:
            parse_idx += 1
        
        if parse_idx < len(lines):
            # åˆ é™¤é‡å¤çš„ "è§£æåçš„æ—¥æœŸ" æ—¥å¿—
            if parse_idx + 1 < len(lines) and 'è§£æåçš„æ—¥æœŸ' in lines[parse_idx + 1]:
                if parse_idx + 2 < len(lines) and 'è§£æåçš„æ—¥æœŸ' in lines[parse_idx + 2]:
                    lines.pop(parse_idx + 2)  # åˆ é™¤é‡å¤çš„ "è§£æåçš„æ—¥æœŸ"
        
        # åœ¨ "å‡†å¤‡è§£ææ—¥æœŸ" ä¹‹åæ’å…¥è‹±æ–‡æ—¥æœŸè§£æä»£ç 
        insert_code = [
            ' ' * indent + '// å…ˆå°è¯•è§£æè‹±æ–‡æ—¥æœŸæ ¼å¼ï¼ˆå¦‚ "Modified January 9, 2024"ï¼‰\n',
            ' ' * indent + 'let parsedDate = null;\n',
            ' ' * indent + 'const englishDateMatch = dateText.match(/(?:Modified|Updated)?\\s*(January|February|March|April|May|June|July|August|September|October|November|December)\\s+(\\d{1,2}),\\s*(\\d{4})/i);\n',
            ' ' * indent + 'if (englishDateMatch) {\n',
            ' ' * (indent + 2) + 'const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];\n',
            ' ' * (indent + 2) + 'const monthIndex = monthNames.findIndex(m => m.toLowerCase() === englishDateMatch[1].toLowerCase());\n',
            ' ' * (indent + 2) + 'if (monthIndex !== -1) {\n',
            ' ' * (indent + 4) + 'const year = parseInt(englishDateMatch[3]);\n',
            ' ' * (indent + 4) + 'const month = monthIndex + 1;\n',
            ' ' * (indent + 4) + 'const day = parseInt(englishDateMatch[2]);\n',
            ' ' * (indent + 4) + 'parsedDate = `${year}-${String(month).padStart(2, "0")}-${String(day).padStart(2, "0")}`;\n',
            ' ' * (indent + 4) + 'console.log(`[Puppeteer] âœ… è§£æè‹±æ–‡æ—¥æœŸæˆåŠŸ: "${dateText}" -> "${parsedDate}"`);\n',
            ' ' * (indent + 2) + '}\n',
            ' ' * indent + '}\n',
            ' ' * indent + '\n',
            ' ' * indent + '// å¦‚æœè‹±æ–‡æ—¥æœŸè§£æå¤±è´¥ï¼Œä½¿ç”¨ parseChineseDate\n',
            ' ' * indent + 'if (!parsedDate) {\n',
        ]
        
        # åœ¨ "å‡†å¤‡è§£ææ—¥æœŸ" ä¹‹åæ’å…¥ä»£ç 
        lines[i+1:i+1] = insert_code
        
        # é‡æ–°æ‰¾åˆ° parseChineseDate çš„ä½ç½®ï¼ˆå› ä¸ºæ’å…¥äº†ä»£ç ï¼Œä½ç½®ä¼šå˜åŒ–ï¼‰
        parse_idx = i + 1 + len(insert_code)
        while parse_idx < len(lines) and 'parseChineseDate' not in lines[parse_idx]:
            parse_idx += 1
        
        if parse_idx < len(lines):
            # ä¿®æ”¹ parseChineseDate è°ƒç”¨ï¼Œæ·»åŠ ç¼©è¿›
            lines[parse_idx] = ' ' * (indent + 2) + lines[parse_idx].lstrip()
            
            # æŸ¥æ‰¾ "è§£æåçš„æ—¥æœŸ" æ—¥å¿—
            if parse_idx + 1 < len(lines) and 'è§£æåçš„æ—¥æœŸ' in lines[parse_idx + 1]:
                # åˆ é™¤é‡å¤çš„æ—¥å¿—
                if parse_idx + 2 < len(lines) and 'è§£æåçš„æ—¥æœŸ' in lines[parse_idx + 2]:
                    lines.pop(parse_idx + 2)
                
                # ä¿®æ”¹æ—¥å¿—ï¼Œæ·»åŠ ç¼©è¿›
                lines[parse_idx + 1] = ' ' * (indent + 2) + lines[parse_idx + 1].lstrip()
                
                # åœ¨æ—¥å¿—åæ·»åŠ ç»“æŸæ‹¬å·å’Œèµ‹å€¼
                lines.insert(parse_idx + 2, ' ' * indent + '} else {\n')
                lines.insert(parse_idx + 3, ' ' * indent + '  dateText = parsedDate;\n')
                lines.insert(parse_idx + 4, ' ' * indent + '}\n')
        
        break

with open(file_path, 'w', encoding='utf-8') as f:
    f.writelines(lines)

print("âœ… ä¿®å¤å®Œæˆ")
PYTHON_EOF

# éªŒè¯ä¿®å¤
echo "ä¿®å¤åçš„ä»£ç ï¼š"
sed -n '360,395p' feishu-puppeteer.ts
```

---

## âœ… ç„¶åé‡æ–°æ„å»º

```bash
cd /www/wwwroot/feihub/backend

npm run build

if [ $? -eq 0 ]; then
    echo "âœ… æ„å»ºæˆåŠŸ"
    pm2 restart feihub-backend
else
    echo "âŒ æ„å»ºå¤±è´¥"
    npm run build 2>&1 | tail -30
fi
```

