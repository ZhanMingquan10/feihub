# 在服务器上修复剩余类型错误

## 🔧 需要修复的文件

### 1. 修复 feishu-puppeteer.ts

在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/backend/src/lib`
2. 编辑 `feishu-puppeteer.ts`

**修改 1：** 第 126-128 行
- **修改前：**
```typescript
const element = document.querySelector(selector);
if (element) {
  const text = element.innerText || element.textContent || '';
```
- **修改后：**
```typescript
const element = document.querySelector(selector) as HTMLElement | null;
if (element) {
  const text = element.innerText || element.textContent || '';
```

**修改 2：** 第 197-199 行
- **修改前：**
```typescript
const titleEl = document.querySelector('.wiki-title, .doc-title, .title, [class*="title"]');
if (titleEl) {
  const titleText = titleEl.innerText || titleEl.textContent || '';
```
- **修改后：**
```typescript
const titleEl = document.querySelector('.wiki-title, .doc-title, .title, [class*="title"]') as HTMLElement | null;
if (titleEl) {
  const titleText = titleEl.innerText || titleEl.textContent || '';
```

**修改 3：** 第 235-237 行
- **修改前：**
```typescript
const timeEl = document.querySelector(selector);
if (timeEl) {
  const timeText = timeEl.innerText || timeEl.textContent ||
```
- **修改后：**
```typescript
const timeEl = document.querySelector(selector) as HTMLElement | null;
if (timeEl) {
  const timeText = timeEl.innerText || timeEl.textContent ||
```

**修改 4：** 第 336-339 行
- **修改前：**
```typescript
const clone = element.cloneNode(true);

// 移除不需要的元素
const unwanted = clone.querySelectorAll(`
```
- **修改后：**
```typescript
const clone = element.cloneNode(true) as HTMLElement;

// 移除不需要的元素
const unwanted = clone.querySelectorAll(`
```

**修改 5：** 第 415-417 行
- **修改前：**
```typescript
const body = document.body.cloneNode(true);
const unwanted = body.querySelectorAll('script, style, iframe, noscript, nav, header, footer, .sidebar, .menu, h1, .title, .author, .user-name, .header, .footer, [class*="header"], [class*="footer"], [class*="image"], [class*="attachment"], [class*="media"], [class*="comment"], [class*="Comment"], [class*="highlight"], [class*="Highlight"], [class*="annotation"], [class*="Annotation"], button, .button, [role="button"], [class*="action"], [class*="Action"], img, picture, video, audio');
unwanted.forEach(el => el.remove());
```
- **修改后：**
```typescript
const body = document.body.cloneNode(true) as HTMLElement;
const unwanted = body.querySelectorAll('script, style, iframe, noscript, nav, header, footer, .sidebar, .menu, h1, .title, .author, .user-name, .header, .footer, [class*="header"], [class*="footer"], [class*="image"], [class*="attachment"], [class*="media"], [class*="comment"], [class*="Comment"], [class*="highlight"], [class*="Highlight"], [class*="annotation"], [class*="Annotation"], button, .button, [role="button"], [class*="action"], [class*="Action"], img, picture, video, audio');
unwanted.forEach((el: Element) => el.remove());
```

---

### 2. 修复 feishu-server.ts

在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/backend/src/lib`
2. 编辑 `feishu-server.ts`

**修改 1：** 第 86 行
- **修改前：** `await page.waitForTimeout(5000);`
- **修改后：** `await new Promise(resolve => setTimeout(resolve, 5000));`

**修改 2：** 第 108-109 行
- **修改前：**
```typescript
const titleEl = document.querySelector('.wiki-title, .doc-title, .title');
if (titleEl) return titleEl.innerText.trim();
```
- **修改后：**
```typescript
const titleEl = document.querySelector('.wiki-title, .doc-title, .title') as HTMLElement | null;
if (titleEl) return titleEl.innerText.trim();
```

**修改 3：** 第 140-141 行
- **修改前：**
```typescript
const authorEl = document.querySelector('[data-author], .author, .doc-author');
if (authorEl) return authorEl.innerText.trim() || authorEl.getAttribute('data-author') || '';
```
- **修改后：**
```typescript
const authorEl = document.querySelector('[data-author], .author, .doc-author') as HTMLElement | null;
if (authorEl) return authorEl.innerText.trim() || authorEl.getAttribute('data-author') || '';
```

---

## 🚀 快速修复命令（推荐）

在宝塔终端执行：

```bash
cd /www/wwwroot/feihub/backend

# 修复 feishu-puppeteer.ts
sed -i 's/const element = document.querySelector(selector);/const element = document.querySelector(selector) as HTMLElement | null;/' src/lib/feishu-puppeteer.ts
sed -i 's/const titleEl = document.querySelector('\''.wiki-title, .doc-title, .title, \[class\*="title"\]'\'');/const titleEl = document.querySelector('\''.wiki-title, .doc-title, .title, \[class\*="title"\]'\'') as HTMLElement | null;/' src/lib/feishu-puppeteer.ts
sed -i 's/const timeEl = document.querySelector(selector);/const timeEl = document.querySelector(selector) as HTMLElement | null;/' src/lib/feishu-puppeteer.ts
sed -i 's/const clone = element.cloneNode(true);/const clone = element.cloneNode(true) as HTMLElement;/' src/lib/feishu-puppeteer.ts
sed -i 's/const body = document.body.cloneNode(true);/const body = document.body.cloneNode(true) as HTMLElement;/' src/lib/feishu-puppeteer.ts

# 修复 feishu-server.ts
sed -i 's/await page.waitForTimeout(5000);/await new Promise(resolve => setTimeout(resolve, 5000));/' src/lib/feishu-server.ts
sed -i 's/const titleEl = document.querySelector('\''.wiki-title, .doc-title, .title'\'');/const titleEl = document.querySelector('\''.wiki-title, .doc-title, .title'\'') as HTMLElement | null;/' src/lib/feishu-server.ts
sed -i 's/const authorEl = document.querySelector('\''\[data-author\], .author, .doc-author'\'');/const authorEl = document.querySelector('\''\[data-author\], .author, .doc-author'\'') as HTMLElement | null;/' src/lib/feishu-server.ts

# 重新构建
npm run build
```

---

## ✅ 成功标志

运行 `npm run build` 后，应该看到：

```
> feihub-backend@1.0.0 build
> tsc
```

没有错误信息，并且会生成 `dist/` 目录。

---

## 🎯 推荐操作

**推荐使用快速修复命令**，因为手动修改容易出错。

执行命令后告诉我结果，我们继续。


