# æ•°æ®åº“æƒé™ä¿®å¤æŒ‡å—

## é—®é¢˜è¯´æ˜

é”™è¯¯ï¼š`User 'feihub_user' was denied access on the database 'feihub.public'`

è¿™æ˜¯å› ä¸ºæ•°æ®åº“ç”¨æˆ· `feihub_user` æ²¡æœ‰è®¿é—®æ•°æ®åº“ `feihub` çš„æƒé™ã€‚

---

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€ï¼šåœ¨å®å¡”é¢æ¿é‡æ–°åˆ›å»ºæ•°æ®åº“ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

1. **åˆ é™¤ç°æœ‰æ•°æ®åº“**
   - åœ¨å®å¡”é¢æ¿ï¼Œç‚¹å‡»å·¦ä¾§ **"æ•°æ®åº“"** â†’ **"PostgreSQL"**
   - æ‰¾åˆ° `feihub` æ•°æ®åº“ï¼Œç‚¹å‡»å³ä¾§ **"åˆ é™¤"**
   - ç¡®è®¤åˆ é™¤

2. **é‡æ–°åˆ›å»ºæ•°æ®åº“**
   - ç‚¹å‡» **"æ·»åŠ æ•°æ®åº“"**
   - å¡«å†™ï¼š
     - **æ•°æ®åº“å**ï¼š`feihub`
     - **ç”¨æˆ·å**ï¼š`feihub_user`
     - **å¯†ç **ï¼šè®¾ç½®ä¸€ä¸ªå¼ºå¯†ç ï¼ˆ**è®°ä½è¿™ä¸ªå¯†ç ï¼**ï¼‰
   - ç‚¹å‡» **"æäº¤"**

3. **æ›´æ–° .env æ–‡ä»¶**
   - åœ¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨ä¸­ï¼Œè¿›å…¥ `/www/wwwroot/feihub/backend`
   - ç¼–è¾‘ `.env` æ–‡ä»¶
   - æ›´æ–° `DATABASE_URL` ä¸­çš„å¯†ç ï¼ˆå¦‚æœå¯†ç æ”¹å˜äº†ï¼‰

4. **é‡æ–°è¿è¡Œè¿ç§»**
   ```bash
   cd /www/wwwroot/feihub/backend
   npx prisma migrate deploy
   ```

---

### æ–¹æ¡ˆäºŒï¼šæ‰‹åŠ¨æˆäºˆæƒé™ï¼ˆå¦‚æœä¸æƒ³åˆ é™¤æ•°æ®åº“ï¼‰

åœ¨å®å¡”ç»ˆç«¯æ‰§è¡Œï¼š

```bash
# 1. ä»¥ postgres è¶…çº§ç”¨æˆ·èº«ä»½è¿æ¥æ•°æ®åº“
sudo -u postgres psql

# 2. æˆäºˆæƒé™
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
GRANT ALL PRIVILEGES ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;

# 3. è¿æ¥åˆ° feihub æ•°æ®åº“
\c feihub

# 4. æˆäºˆ schema æƒé™
GRANT ALL ON SCHEMA public TO feihub_user;
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO feihub_user;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO feihub_user;

# 5. é€€å‡º
\q
```

---

### æ–¹æ¡ˆä¸‰ï¼šä½¿ç”¨å®å¡”é¢æ¿çš„ PostgreSQL ç®¡ç†å·¥å…·

1. åœ¨å®å¡”é¢æ¿ï¼Œç‚¹å‡»å·¦ä¾§ **"æ•°æ®åº“"** â†’ **"PostgreSQL"**
2. æ‰¾åˆ° `feihub` æ•°æ®åº“ï¼Œç‚¹å‡»å³ä¾§ **"ç®¡ç†"**
3. åœ¨æ‰“å¼€çš„ phpPgAdmin ä¸­ï¼š
   - ç‚¹å‡»å·¦ä¾§ `feihub` æ•°æ®åº“
   - ç‚¹å‡» **"æƒé™"** æ ‡ç­¾
   - æ·»åŠ ç”¨æˆ· `feihub_user` å¹¶æˆäºˆæ‰€æœ‰æƒé™

---

## ğŸ” éªŒè¯æƒé™

ä¿®å¤åï¼Œå¯ä»¥éªŒè¯æƒé™ï¼š

```bash
# æµ‹è¯•è¿æ¥
cd /www/wwwroot/feihub/backend
psql -U feihub_user -d feihub -c "SELECT version();"
```

å¦‚æœæˆåŠŸï¼Œåº”è¯¥æ˜¾ç¤º PostgreSQL ç‰ˆæœ¬ä¿¡æ¯ã€‚

---

## ğŸ“ å®Œæ•´çš„ä¿®å¤æ­¥éª¤ï¼ˆæ¨èæ–¹æ¡ˆä¸€ï¼‰

### æ­¥éª¤ 1ï¼šåˆ é™¤å¹¶é‡æ–°åˆ›å»ºæ•°æ®åº“

1. åœ¨å®å¡”é¢æ¿ï¼Œç‚¹å‡»å·¦ä¾§ **"æ•°æ®åº“"** â†’ **"PostgreSQL"**
2. æ‰¾åˆ° `feihub` æ•°æ®åº“ï¼Œç‚¹å‡»å³ä¾§ **"åˆ é™¤"**
3. ç‚¹å‡» **"æ·»åŠ æ•°æ®åº“"**
4. å¡«å†™ï¼š
   - **æ•°æ®åº“å**ï¼š`feihub`
   - **ç”¨æˆ·å**ï¼š`feihub_user`
   - **å¯†ç **ï¼šè®¾ç½®ä¸€ä¸ªæ–°å¯†ç ï¼ˆ**è®°ä½è¿™ä¸ªå¯†ç ï¼**ï¼‰
5. ç‚¹å‡» **"æäº¤"**

### æ­¥éª¤ 2ï¼šæ›´æ–° .env æ–‡ä»¶

åœ¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨ä¸­ï¼š
1. è¿›å…¥ `/www/wwwroot/feihub/backend`
2. ç¼–è¾‘ `.env` æ–‡ä»¶
3. æ›´æ–° `DATABASE_URL`ï¼š

```env
DATABASE_URL=postgresql://feihub_user:æ–°å¯†ç @localhost:5432/feihub?schema=public
```

### æ­¥éª¤ 3ï¼šé‡æ–°è¿è¡Œè¿ç§»

```bash
cd /www/wwwroot/feihub/backend
npx prisma migrate deploy
```

---

## ğŸ†˜ å¦‚æœè¿˜æ˜¯å¤±è´¥

### æ£€æŸ¥æ•°æ®åº“ç”¨æˆ·æ˜¯å¦å­˜åœ¨

```bash
sudo -u postgres psql -c "\du"
```

åº”è¯¥èƒ½çœ‹åˆ° `feihub_user` ç”¨æˆ·ã€‚

### æ£€æŸ¥æ•°æ®åº“æ˜¯å¦å­˜åœ¨

```bash
sudo -u postgres psql -c "\l"
```

åº”è¯¥èƒ½çœ‹åˆ° `feihub` æ•°æ®åº“ã€‚

### æ£€æŸ¥è¿æ¥

```bash
cd /www/wwwroot/feihub/backend
psql -U feihub_user -d feihub -c "SELECT 1;"
```

å¦‚æœè¿æ¥å¤±è´¥ï¼Œè¯´æ˜æƒé™é—®é¢˜è¿˜æ²¡è§£å†³ã€‚

---

## âœ… æˆåŠŸæ ‡å¿—

è¿è¡Œ `npx prisma migrate deploy` åï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Datasource "db": PostgreSQL database "feihub", schema "public" at "localhost:5432"

Applying migration `20251128025133_add_content_field`
Applying migration `20251128054005_add_ai_structured_summary`

The following migration(s) have been applied:

migrations/
  â””â”€ 20251128025133_add_content_field/
      â””â”€ migration.sql
  â””â”€ 20251128054005_add_ai_structured_summary/
      â””â”€ migration.sql

All migrations have been successfully applied.
```

---

## ğŸ“‹ å¿«é€Ÿä¿®å¤å‘½ä»¤ï¼ˆæ–¹æ¡ˆäºŒï¼‰

å¦‚æœä½ æƒ³å¿«é€Ÿä¿®å¤è€Œä¸åˆ é™¤æ•°æ®åº“ï¼Œå¯ä»¥æ‰§è¡Œï¼š

```bash
# æˆäºˆæƒé™
sudo -u postgres psql <<EOF
GRANT ALL PRIVILEGES ON DATABASE feihub TO feihub_user;
\c feihub
GRANT ALL ON SCHEMA public TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO feihub_user;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON SEQUENCES TO feihub_user;
EOF

# é‡æ–°è¿è¡Œè¿ç§»
cd /www/wwwroot/feihub/backend
npx prisma migrate deploy
```


