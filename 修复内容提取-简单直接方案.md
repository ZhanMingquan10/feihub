# ä¿®å¤å†…å®¹æå–é—®é¢˜ - ç®€å•ç›´æ¥æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

ä»æ—¥å¿—çœ‹åˆ°ï¼š
- å†…å®¹é•¿åº¦åªæœ‰ 29
- å†…å®¹é¢„è§ˆï¼š`Help CenterKeyboard Shortcuts`
- è¯´æ˜æå–åˆ°äº†å¯¼èˆªæ ï¼Œè€Œä¸æ˜¯æ­£æ–‡

**æ ¹æœ¬åŸå› ï¼š**
1. ç­‰å¾…æ—¶é—´ä¸å¤Ÿï¼ˆåªæœ‰5ç§’ï¼‰ï¼Œæ­£æ–‡è¿˜æ²¡å®Œå…¨æ¸²æŸ“
2. é€‰æ‹©å™¨åŒ¹é…åˆ°äº†å¯¼èˆªæ è€Œä¸æ˜¯æ­£æ–‡
3. æ²¡æœ‰éªŒè¯å†…å®¹æ˜¯å¦åŒ…å«ä¸­æ–‡

## ğŸš€ å¿«é€Ÿä¿®å¤æ–¹æ¡ˆ

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

# å¤‡ä»½
for f in feishu*.ts; do cp "$f" "${f}.bak"; done

# ä¿®å¤ï¼šå¢åŠ ç­‰å¾…æ—¶é—´å’Œæ”¹è¿›é€‰æ‹©å™¨
python3 << 'PYEOF'
import re

for file_path in ['feishu-puppeteer.ts', 'feishu-server.ts']:
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()
        original = content
        
        # 1. å¢åŠ ç­‰å¾…æ—¶é—´ï¼ˆ5ç§’ -> 15ç§’ï¼‰
        content = content.replace(
            'await new Promise(resolve => setTimeout(resolve, 5000));',
            '''// ç­‰å¾…å†…å®¹å®Œå…¨æ¸²æŸ“ï¼ˆå¢åŠ åˆ°15ç§’ï¼‰
        await new Promise(resolve => setTimeout(resolve, 15000));
        
        // ç­‰å¾…æ­£æ–‡å†…å®¹å…ƒç´ å‡ºç°
        try {
            await page.waitForSelector('[class*="content"], article, .wiki-content, .doc-content', { timeout: 10000 });
            console.log('[å†…å®¹æå–] âœ… æ‰¾åˆ°å†…å®¹å…ƒç´ ');
            // å†ç­‰å¾…3ç§’ç¡®ä¿å†…å®¹å®Œå…¨åŠ è½½
            await new Promise(resolve => setTimeout(resolve, 3000));
        } catch (e) {
            console.log('[å†…å®¹æå–] âš ï¸ æœªæ‰¾åˆ°å†…å®¹å…ƒç´ ï¼Œç»§ç»­æå–...');
        }'''
        )
        
        # 2. åœ¨å†…å®¹æå–åæ·»åŠ éªŒè¯å’Œè¿‡æ»¤
        # æŸ¥æ‰¾è¿”å›æ–‡æœ¬çš„åœ°æ–¹ï¼Œæ·»åŠ éªŒè¯
        pattern = r'(return\s+(?:text|bodyText|cleanText)\.trim\(\);)'
        def add_validation(match):
            var = re.search(r'return\s+(\w+)', match.group(1)).group(1) if re.search(r'return\s+(\w+)', match.group(1)) else 'text'
            return f'''// éªŒè¯å†…å®¹ï¼šå¿…é¡»åŒ…å«ä¸­æ–‡ä¸”è¶³å¤Ÿé•¿
            if ({var} && (
                {var}.includes('Help Center') || 
                {var}.includes('Keyboard Shortcuts') ||
                {var}.includes('Token Limit') ||
                {var}.length < 100 ||
                (!/[\\u4e00-\\u9fa5]/.test({var}) && {var}.length < 200)
            )) {{
                console.log('[å†…å®¹æå–] âŒ å†…å®¹æ— æ•ˆï¼Œè·³è¿‡');
                continue; // æˆ–è¿”å›ç©ºå­—ç¬¦ä¸²
            }}
            console.log('[å†…å®¹æå–] âœ… å†…å®¹æœ‰æ•ˆï¼Œé•¿åº¦:', {var}.length);
            return {var}.trim();'''
        
        content = re.sub(pattern, add_validation, content)
        
        # 3. åœ¨ bodyText æå–åæ·»åŠ æ¸…ç†
        if 'bodyText' in content:
            pattern2 = r'(let\s+bodyText\s*=\s*\(body\.(?:innerText|textContent)[^;]+\.trim\(\);)'
            def add_cleanup(match):
                return match.group(1) + '''
        
        // ç§»é™¤å¯¼èˆªæ å†…å®¹
        bodyText = bodyText
            .replace(/Help Center[^\\n]*/gi, '')
            .replace(/Keyboard Shortcuts[^\\n]*/gi, '')
            .replace(/Token Limit[^\\n]*/gi, '')
            .replace(/å¿«æ·é”®[^\\n]*/gi, '')
            .replace(/\\s+/g, ' ')
            .trim();
        
        // åªä¿ç•™åŒ…å«ä¸­æ–‡çš„æ®µè½
        const paragraphs = bodyText.split(/\\n\\n+/);
        const validParagraphs = paragraphs.filter(p => 
            /[\\u4e00-\\u9fa5]/.test(p) && 
            p.length > 50 && 
            !p.includes('Help Center') &&
            !p.includes('Keyboard Shortcuts')
        );
        
        if (validParagraphs.length > 0) {
            bodyText = validParagraphs.join('\\n\\n');
            console.log('[å†…å®¹æå–] âœ… æ‰¾åˆ°', validParagraphs.length, 'ä¸ªæœ‰æ•ˆæ®µè½');
        } else if (bodyText.length < 100 || !/[\\u4e00-\\u9fa5]/.test(bodyText)) {
            bodyText = '';
            console.log('[å†…å®¹æå–] âŒ bodyText æ— æ•ˆ');
        }'''
            content = re.sub(pattern2, add_cleanup, content)
        
        if content != original:
            with open(file_path + '.bak', 'w', encoding='utf-8') as f:
                f.write(original)
            with open(file_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"âœ… å·²ä¿®å¤: {file_path}")
        else:
            print(f"âš ï¸  æœªä¿®æ”¹: {file_path}")
    except FileNotFoundError:
        print(f"âš ï¸  æ–‡ä»¶ä¸å­˜åœ¨: {file_path}")
PYEOF

# é‡æ–°æ„å»º
cd /www/wwwroot/feihub/backend
npm run build && pm2 restart feihub-backend && echo "âœ… ä¿®å¤å®Œæˆï¼"
```

---

## ğŸ“ ä¿®å¤å†…å®¹

1. **å¢åŠ ç­‰å¾…æ—¶é—´**ï¼šä»5ç§’å¢åŠ åˆ°15ç§’ + ç­‰å¾…å†…å®¹å…ƒç´ å‡ºç° + å†ç­‰3ç§’
2. **æ·»åŠ å†…å®¹éªŒè¯**ï¼šç¡®ä¿æå–çš„å†…å®¹åŒ…å«ä¸­æ–‡ä¸”è¶³å¤Ÿé•¿
3. **è¿‡æ»¤å¯¼èˆªæ **ï¼šç§»é™¤æ‰€æœ‰åŒ…å« "Help Center"ã€"Keyboard Shortcuts" çš„å†…å®¹
4. **æ™ºèƒ½é€‰æ‹©æ®µè½**ï¼šåªä¿ç•™åŒ…å«ä¸­æ–‡çš„æœ‰æ•ˆæ®µè½

---

æ‰§è¡Œåé‡æ–°æµ‹è¯•ï¼Œåº”è¯¥èƒ½æ­£ç¡®æå–åˆ°æ­£æ–‡å†…å®¹äº†ã€‚

