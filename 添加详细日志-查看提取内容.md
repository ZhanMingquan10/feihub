# 添加详细日志 - 查看实际提取的内容

## 🔍 目标

在内容提取的关键位置添加详细日志，查看实际提取到了什么内容。

## 🚀 在服务器上执行

### 第一步：添加详细日志

在服务器上执行以下命令，在内容提取的关键位置添加日志：

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 备份文件
for f in feishu*.ts; do cp "$f" "${f}.bak"; done

# 使用 Python 添加日志
python3 << 'PYEOF'
import re
import glob

def add_logging(file_path):
    print(f"处理: {file_path}")
    with open(file_path, 'r', encoding='utf-8') as f:
        content = f.read()
    original = content
    
    # 在提取文本后添加日志
    pattern1 = r'(const\s+text\s*=\s*(?:cloned|element)\.(?:innerText|textContent)\s*\|\|\s*[^;]+;)'
    def add_log1(match):
        return match.group(1) + '''
            console.log(`[内容提取] 提取的文本（前200字符）: "${text.substring(0, 200)}"`);
            console.log(`[内容提取] 文本长度: ${text.length}`);
            console.log(`[内容提取] 是否包含 Help Center: ${text.includes('Help Center')}`);
            console.log(`[内容提取] 是否包含 Keyboard: ${text.includes('Keyboard')}`);'''
    content = re.sub(pattern1, add_log1, content)
    
    # 在 bodyText 提取后添加日志
    pattern2 = r'(let\s+bodyText\s*=\s*\(body\.(?:innerText|textContent)[^;]+\.trim\(\);)'
    def add_log2(match):
        return match.group(1) + '''
            console.log(`[内容提取] bodyText（前500字符）: "${bodyText.substring(0, 500)}"`);
            console.log(`[内容提取] bodyText 长度: ${bodyText.length}`);'''
    content = re.sub(pattern2, add_log2, content)
    
    # 在返回前添加日志
    pattern3 = r'(return\s+(?:text|bodyText|cleanText)\.trim\(\);)'
    def add_log3(match):
        var = re.search(r'return\s+(\w+)', match.group(1)).group(1) if re.search(r'return\s+(\w+)', match.group(1)) else 'text'
        return f'''console.log(`[内容提取] 最终返回的内容（前500字符）: "${{{var}.substring(0, 500)}}"`);
            console.log(`[内容提取] 最终内容长度: ${{{var}.length}}`);
            return {var}.trim();'''
    content = re.sub(pattern3, add_log3, content)
    
    if content != original:
        with open(file_path, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"  ✅ 已添加日志")
        return True
    return False

for f in glob.glob('feishu*.ts'):
    add_logging(f)
PYEOF
```

### 第二步：重新构建和重启

```bash
cd /www/wwwroot/feihub/backend
npm run build
pm2 restart feihub-backend
```

### 第三步：重新测试并查看日志

```bash
# 清空之前的日志（可选）
pm2 flush feihub-backend

# 重新测试文档提取后，查看日志
pm2 logs feihub-backend --lines 500 --nostream | grep -E "\[内容提取\]" | tail -50
```

---

## 📝 或者更简单的方法：直接查看现有日志

```bash
cd /www/wwwroot/feihub/backend

# 查看最近的提取日志
pm2 logs feihub-backend --lines 500 --nostream > /tmp/extract_logs.txt

# 查看内容相关的日志
cat /tmp/extract_logs.txt | grep -E "(内容|content|提取|bodyText|Help|Keyboard)" | tail -100

# 查看特定文档的日志
cat /tmp/extract_logs.txt | grep -A 30 "VGoXdFXmooasHUxsZ0icAD2WnGe"
```

---

请先执行**更简单的方法**（直接查看现有日志），把输出发给我，我们一起分析。

