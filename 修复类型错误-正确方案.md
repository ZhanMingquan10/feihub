# 修复类型错误 - 正确方案

## 🔍 问题

TypeScript 在编译时检查类型，即使添加了运行时 null 检查，类型系统仍然认为 `content` 可能是 `null`。

## 🚀 正确的修复方法

需要在赋值时直接处理类型，使用 `|| ''` 或类型断言。

在服务器上执行：

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 查看第414行附近的代码结构
sed -n '410,425p' feishu-puppeteer.ts

# 修复：修改赋值语句，直接处理 null
python3 << 'PYEOF'
with open('feishu-puppeteer.ts', 'r', encoding='utf-8') as f:
    content = f.read()

original = content

# 方法1：在 await page.evaluate 外层添加括号和 || ''
# 查找 content = await page.evaluate 的模式
import re

# 需要找到完整的 page.evaluate 调用，包括闭合括号
# 查找模式：content = await page.evaluate(...);
pattern = r'(content\s*=\s*)await\s+page\.evaluate\(([^)]+)\);'

def fix_assignment(match):
    prefix = match.group(1)
    args = match.group(2)
    # 在 await 外层添加括号，并在末尾添加 || ''
    return f'{prefix}(await page.evaluate({args})) || \'\';'

content = re.sub(pattern, fix_assignment, content)

# 如果上面的正则不行，使用更简单的方法：直接查找并替换
if content == original:
    # 查找 content = await page.evaluate 这一行
    lines = content.split('\n')
    for i, line in enumerate(lines):
        if 'content = await page.evaluate' in line and i >= 410 and i <= 420:
            # 找到对应的闭合括号（可能在多行后）
            # 先尝试简单方法：在这行末尾添加 || ''
            if line.strip().endswith('{'):
                # 如果这行以 { 结尾，说明是开始，需要找到对应的 });
                # 查找后面的 });
                for j in range(i+1, min(i+100, len(lines))):
                    if '});' in lines[j]:
                        # 在 }); 后添加 || ''
                        lines[j] = lines[j].replace('});', '}) || \'\';')
                        print(f"✅ 修复第 {j+1} 行")
                        break
            else:
                # 如果这行包含完整的表达式，直接修改
                lines[i] = line.replace('await page.evaluate', '(await page.evaluate').replace(';', ') || \'\';')
                print(f"✅ 修复第 {i+1} 行")
            break
    content = '\n'.join(lines)

if content != original:
    with open('feishu-puppeteer.ts.bak5', 'w', encoding='utf-8') as f:
        f.write(original)
    with open('feishu-puppeteer.ts', 'w', encoding='utf-8') as f:
        f.write(content)
    print("✅ 已修复类型错误")
else:
    print("⚠️  未找到需要修复的代码，可能需要手动修复")
PYEOF

# 重新构建
cd /www/wwwroot/feihub/backend
npm run build && pm2 restart feihub-backend && echo "✅ 修复完成！"
```

---

## 📝 如果上面的方法不行，查看代码结构后手动修复

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 查看第414行附近的完整代码结构
sed -n '410,450p' feishu-puppeteer.ts
```

找到 `page.evaluate` 的闭合括号（应该是 `});`），然后修改为 `}) || '';`

---

## 📝 最简单的方法：使用类型断言

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 修改第414行，添加类型断言
sed -i '414s/content = await page.evaluate/content = (await page.evaluate as any/' feishu-puppeteer.ts

# 然后找到对应的 }); 并修改
# 先查看结构
sed -n '414,450p' feishu-puppeteer.ts | grep -n "});"
```

---

请先执行第一个命令，如果不行，把 `sed -n '410,450p' feishu-puppeteer.ts` 的输出发给我，我会根据实际代码结构提供精确的修复方案。

