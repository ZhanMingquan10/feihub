# FeiHub 服务器部署指南

## 飞书文档爬取方案

### 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|----------|
| **Puppeteer** | 支持 JavaScript 渲染，能获取动态内容 | 需要安装 Chrome，资源消耗较大 | 需要完整内容提取 |
| **Cheerio** | 轻量级，资源消耗小 | 只能获取静态 HTML，无法处理动态内容 | 静态页面或作为备选 |
| **飞书 OpenAPI** | 官方 API，稳定可靠 | 需要申请 API Key，可能有权限限制 | 最佳方案（如果可用） |

## 推荐方案：Puppeteer（已优化）

### 为什么选择 Puppeteer？

1. **支持动态渲染**：飞书文档是 JavaScript 动态加载的，Puppeteer 可以完整获取内容
2. **服务器优化**：已针对服务器环境优化配置（单进程模式、资源拦截等）
3. **跨平台支持**：支持 Windows、Linux、macOS

### 服务器部署步骤

#### 1. 安装 Chrome/Chromium

**阿里云/腾讯云 Linux 服务器：**

```bash
# Ubuntu/Debian
wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
sudo apt-get update
sudo apt-get install -y google-chrome-stable

# 或者安装 Chromium（更轻量）
sudo apt-get install -y chromium-browser
```

**CentOS/RHEL：**

```bash
# 安装 Chromium
sudo yum install -y chromium
```

#### 2. 设置环境变量（可选）

如果 Chrome 不在默认路径，设置环境变量：

```bash
# Linux
export CHROME_PATH=/usr/bin/google-chrome-stable
# 或
export CHROME_PATH=/usr/bin/chromium-browser

# 添加到 ~/.bashrc 或 ~/.profile 使其永久生效
echo 'export CHROME_PATH=/usr/bin/google-chrome-stable' >> ~/.bashrc
```

#### 3. 安装依赖

```bash
cd backend
npm install
```

#### 4. 启动服务

```bash
npm run dev  # 开发环境
# 或
npm run build && npm start  # 生产环境
```

### 资源优化

已优化的配置：
- ✅ 单进程模式（`--single-process`）- 节省内存
- ✅ 禁用不必要的功能（GPU、音频、同步等）
- ✅ 请求拦截（跳过图片、字体、媒体等）
- ✅ 超时控制（30秒）

### 备选方案：如果 Puppeteer 不可用

如果服务器无法安装 Chrome，系统会自动回退到：
1. **Cheerio 静态爬取**（可能无法获取完整内容）
2. **简化方案**（返回链接，提示用户查看原文档）

## 性能考虑

### 资源消耗

- **内存**：每个 Puppeteer 实例约 100-200MB
- **CPU**：页面渲染时会有短暂峰值
- **时间**：每个文档处理约 5-10 秒

### 优化建议

1. **使用队列**：已实现，避免并发过多
2. **超时控制**：已设置 30 秒超时
3. **浏览器复用**：可以考虑（但会增加复杂度）
4. **缓存机制**：相同链接不重复爬取（已实现）

## 故障排除

### Chrome 未找到

```bash
# 检查 Chrome 是否安装
which google-chrome-stable
which chromium-browser

# 如果已安装但找不到，设置环境变量
export CHROME_PATH=$(which google-chrome-stable)
```

### 权限问题

```bash
# 确保 Chrome 有执行权限
chmod +x /usr/bin/google-chrome-stable
```

### 内存不足

如果服务器内存较小（< 1GB），考虑：
1. 使用 Chromium 替代 Chrome（更轻量）
2. 增加服务器内存
3. 使用简化方案（不爬取内容）

## 监控和日志

后端会输出详细日志：
- `[Puppeteer]` - Puppeteer 相关日志
- `[爬取]` - 爬取过程日志
- `[处理文档]` - 文档处理日志

## 总结

**推荐使用 Puppeteer 方案**，因为：
1. ✅ 能完整获取飞书文档内容
2. ✅ 已针对服务器环境优化
3. ✅ 有完善的错误处理和降级方案
4. ✅ 支持跨平台部署

如果服务器资源非常有限，可以考虑：
- 使用 Chromium 替代 Chrome
- 或者接受简化方案（不自动提取内容）


