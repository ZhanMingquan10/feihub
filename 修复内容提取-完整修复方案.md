# ä¿®å¤å†…å®¹æå– - å®Œæ•´ä¿®å¤æ–¹æ¡ˆ

## ğŸ” é—®é¢˜åˆ†æ

ä»æ—¥å¿—çœ‹ï¼š
- `page.evaluate` æå–åˆ° 29 å­—ç¬¦ï¼š"Help CenterKeyboard Shortcuts"
- ç„¶åä½¿ç”¨äº† cheerio å¤‡ç”¨æ–¹æ¡ˆ
- æœ€ç»ˆç»“æœè¿˜æ˜¯å¯¼èˆªæ å†…å®¹

éœ€è¦åœ¨ä¸¤ä¸ªåœ°æ–¹ä¿®å¤ï¼š
1. `page.evaluate` ä¸­ï¼Œåœ¨æå–æ–‡æœ¬åç«‹å³éªŒè¯
2. `cheerio` å¤‡ç”¨æ–¹æ¡ˆä¸­ï¼Œä¹Ÿæ·»åŠ è¿‡æ»¤

## ğŸš€ å®Œæ•´ä¿®å¤

åœ¨æœåŠ¡å™¨ä¸Šæ‰§è¡Œï¼š

```bash
cd /www/wwwroot/feihub/backend/src/lib

# 1. æŸ¥çœ‹ cheerio å¤‡ç”¨æ–¹æ¡ˆçš„ä»£ç 
grep -A 30 "cheerio å¤‡ç”¨æ–¹æ¡ˆ" feishu-puppeteer.ts | head -40

# 2. æŸ¥çœ‹ page.evaluate ä¸­æ–‡æœ¬æå–çš„ä½ç½®
grep -B 5 -A 10 "let text = clone.innerText" feishu-puppeteer.ts | head -20
```

æŠŠè¾“å‡ºå‘ç»™æˆ‘ï¼Œæˆ‘ä¼šæ ¹æ®å®é™…ä»£ç æä¾›ç²¾ç¡®çš„ä¿®å¤æ–¹æ¡ˆã€‚

---

## ğŸ“ æˆ–è€…ç›´æ¥ä¿®å¤ï¼ˆå¦‚æœä»£ç ç»“æ„å·²çŸ¥ï¼‰

```bash
cd /www/wwwroot/feihub/backend/src/lib && \
python3 << 'PYEOF'
with open('feishu-puppeteer.ts', 'r', encoding='utf-8') as f:
    lines = f.readlines()

# ä¿®å¤1: åœ¨ page.evaluate ä¸­ï¼Œlet text = clone.innerText åç«‹å³æ·»åŠ éªŒè¯
for i, line in enumerate(lines):
    if 'let text = clone.innerText' in line or 'let text = clone.textContent' in line:
        # åœ¨è¿™è¡Œåç«‹å³æ·»åŠ éªŒè¯
        indent = len(line) - len(line.lstrip())
        indent_str = ' ' * indent
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰éªŒè¯
        has_validation = any('Help Center' in lines[j] and j > i and j < i+10 for j in range(len(lines)))
        if not has_validation:
            lines.insert(i+1, f"{indent_str}\n")
            lines.insert(i+2, f"{indent_str}// ç«‹å³éªŒè¯ï¼šæ’é™¤å¯¼èˆªæ ï¼ˆåœ¨ä»»ä½•å¤„ç†ä¹‹å‰ï¼‰\n")
            lines.insert(i+3, f"{indent_str}if (text && (text.includes('Help Center') || text.includes('Keyboard Shortcuts') || text.includes('Token Limit'))) {{\n")
            lines.insert(i+4, f"{indent_str}  continue; // è·³è¿‡å¯¼èˆªæ \n")
            lines.insert(i+5, f"{indent_str}}}\n")
            print(f"âœ… åœ¨ç¬¬ {i+1} è¡Œåæ·»åŠ éªŒè¯")
            break

# ä¿®å¤2: åœ¨ cheerio å¤‡ç”¨æ–¹æ¡ˆä¸­æ·»åŠ è¿‡æ»¤
for i, line in enumerate(lines):
    if 'cheerio å¤‡ç”¨æ–¹æ¡ˆ' in line or 'ä½¿ç”¨ cheerio å¤‡ç”¨æ–¹æ¡ˆ' in line:
        # æŸ¥æ‰¾åé¢çš„ content èµ‹å€¼
        for j in range(i+1, min(i+50, len(lines))):
            if 'content =' in lines[j] and ('$(' in lines[j] or '.text()' in lines[j]):
                # åœ¨è¿™è¡Œåæ·»åŠ è¿‡æ»¤
                indent = len(lines[j]) - len(lines[j].lstrip())
                indent_str = ' ' * indent
                k = j + 1
                while k < len(lines) and (not lines[k].strip() or lines[k].strip().startswith('//')):
                    k += 1
                has_filter = any('Help Center' in lines[m] for m in range(j+1, min(j+20, len(lines))))
                if not has_filter:
                    lines.insert(k, f"{indent_str}\n")
                    lines.insert(k+1, f"{indent_str}// è¿‡æ»¤å¯¼èˆªæ å†…å®¹\n")
                    lines.insert(k+2, f"{indent_str}if (content && (content.includes('Help Center') || content.includes('Keyboard Shortcuts') || content.includes('Token Limit'))) {{\n")
                    lines.insert(k+3, f"{indent_str}  content = '';\n")
                    lines.insert(k+4, f"{indent_str}}}\n")
                    print(f"âœ… åœ¨ cheerio æå–åæ·»åŠ è¿‡æ»¤ï¼ˆç¬¬ {j+1} è¡Œåï¼‰")
                break
        break

with open('feishu-puppeteer.ts.bak15', 'w', encoding='utf-8') as f:
    f.writelines(lines)
with open('feishu-puppeteer.ts', 'w', encoding='utf-8') as f:
    f.writelines(lines)
print("âœ… ä¿®å¤å®Œæˆ")
PYEOF
cd /www/wwwroot/feihub/backend && npm run build && pm2 restart feihub-backend && echo "âœ… ä¿®å¤å®Œæˆï¼"
```

---

è¯·å…ˆæ‰§è¡Œç¬¬ä¸€ä¸ªå‘½ä»¤æŸ¥çœ‹ä»£ç ç»“æ„ï¼ŒæŠŠè¾“å‡ºå‘ç»™æˆ‘ï¼Œæˆ‘ä¼šæä¾›æ›´ç²¾ç¡®çš„ä¿®å¤æ–¹æ¡ˆã€‚

