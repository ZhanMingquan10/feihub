# 服务器部署步骤（从 GitHub 开始）

## ✅ 已完成
- [x] 本地代码已推送到 GitHub：https://github.com/ZhanMingquan/feihub

---

## 🚀 下一步：在服务器上部署

### 第一步：登录服务器

1. **登录宝塔面板**
   - 访问：`http://你的服务器IP:8888`
   - 使用 `bt default` 显示的用户名和密码登录

2. **打开终端**
   - 在宝塔面板，点击左侧"终端"

---

### 第二步：安装 Git（如果还没安装）

在终端执行：
```bash
# Ubuntu/Debian
apt update
apt install git -y

# 验证安装
git --version
```

---

### 第三步：从 GitHub 克隆代码

在终端执行：
```bash
# 进入网站根目录
cd /www/wwwroot/

# 从 GitHub 克隆代码
git clone https://github.com/ZhanMingquan/feihub.git

# 进入项目目录
cd feihub

# 查看文件（确认克隆成功）
ls -la
```

---

### 第四步：安装必要软件

参考 `宝塔面板套件安装指南.md`，安装：
1. Node.js（通过宝塔软件商店）
2. PostgreSQL（通过宝塔软件商店）
3. Redis（通过宝塔软件商店）
4. PM2（在终端执行：`npm install -g pm2`）

---

### 第五步：创建数据库

1. 在宝塔面板，点击左侧"数据库" → "PostgreSQL"
2. 点击"添加数据库"
3. 填写：
   - **数据库名**：`feihub`
   - **用户名**：`feihub_user`
   - **密码**：设置一个强密码（**记住这个密码！**）
4. 点击"提交"

---

### 第六步：配置后端

#### 6.1 安装后端依赖
```bash
cd /www/wwwroot/feihub/backend
npm install --production
```

#### 6.2 创建 `.env` 文件
在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/backend`
2. 创建 `.env` 文件
3. 编辑并添加以下内容（**替换为你的实际值**）：

```env
# 服务器配置
PORT=4000
NODE_ENV=production

# 数据库配置（使用第五步创建的数据库信息）
DATABASE_URL=postgresql://feihub_user:你的数据库密码@localhost:5432/feihub

# Redis 配置
REDIS_URL=redis://localhost:6379

# AI API 配置（必须配置其中一个）
DEEPSEEK_API_KEY=your_deepseek_api_key
# 或
# OPENAI_API_KEY=your_openai_api_key

# CORS 配置（你的域名）
CORS_ORIGIN=https://feihub.top

# 客服图片URL（可选）
# CUSTOMER_SERVICE_IMAGE_URL=https://your-cdn.com/kefu.png
```

#### 6.3 运行数据库迁移
```bash
cd /www/wwwroot/feihub/backend
npx prisma generate
npx prisma migrate deploy
```

#### 6.4 构建后端
```bash
npm run build
```

#### 6.5 启动后端服务
```bash
# 创建日志目录
mkdir -p logs

# 启动服务
pm2 start ecosystem.config.js

# 保存配置
pm2 save

# 设置开机自启（执行后会显示一行命令，复制并执行它）
pm2 startup
```

#### 6.6 验证后端运行
```bash
# 查看服务状态
pm2 status

# 查看日志
pm2 logs feihub-backend
```

---

### 第七步：构建和部署前端

#### 7.1 安装前端依赖
```bash
cd /www/wwwroot/feihub
npm install
```

#### 7.2 创建前端环境变量
在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub`
2. 创建 `.env.production` 文件
3. 添加以下内容：

```env
VITE_API_BASE=https://feihub.top/api
# 如果客服图片使用CDN，取消下面的注释
# VITE_CUSTOMER_SERVICE_IMAGE_URL=https://your-cdn.com/kefu.png
```

#### 7.3 构建前端
```bash
npm run build
```

#### 7.4 上传客服图片
在宝塔文件管理器中：
1. 进入 `/www/wwwroot/feihub/dist`
2. 上传 `kefu.png` 文件到这个目录

---

### 第八步：配置 Nginx

1. 在宝塔面板，点击左侧"网站"
2. 点击"添加站点"
3. 填写：
   - **域名**：`feihub.top`（和 `www.feihub.top`）
   - **根目录**：`/www/wwwroot/feihub/dist`
   - **PHP版本**：纯静态
4. 点击"提交"

5. **配置反向代理**（用于后端 API）：
   - 点击站点右侧"设置"
   - 点击"反向代理" → "添加反向代理"
   - 填写：
     - **代理名称**：`api`
     - **目标URL**：`http://127.0.0.1:4000`
     - **发送域名**：`$host`
   - 点击"提交"

6. **配置 SSL 证书**（推荐）：
   - 点击站点右侧"设置"
   - 点击"SSL" → "Let's Encrypt"
   - 勾选域名，点击"申请"
   - 申请成功后，点击"强制HTTPS"

---

### 第九步：验证部署

1. **访问网站**：`https://feihub.top`
2. **测试功能**：
   - 搜索文档
   - 分享文档
   - 查看文档详情

---

## 🔄 后续更新代码

当你在本地修改代码后：

1. **本地推送**：
   ```bash
   git add .
   git commit -m "描述修改内容"
   git push
   ```

2. **服务器更新**：
   ```bash
   cd /www/wwwroot/feihub
   git pull
   
   # 更新后端
   cd backend
   npm install --production
   npm run build
   pm2 restart feihub-backend
   
   # 更新前端
   cd ..
   npm install
   npm run build
   ```

---

## 📝 重要提示

1. **环境变量**：`.env` 文件包含敏感信息，不要上传到 GitHub
2. **数据库密码**：记住你设置的数据库密码
3. **API Key**：确保在 `.env` 中配置了 AI API Key
4. **客服图片**：记得上传 `kefu.png` 到 `dist` 目录

---

## 🆘 遇到问题？

参考以下文档：
- `feihub.top部署指南.md` - 完整部署指南
- `宝塔面板套件安装指南.md` - 软件安装指南
- `域名DNS配置指南.md` - 域名配置指南


