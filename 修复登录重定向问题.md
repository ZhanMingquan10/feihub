# 修复登录重定向问题

## 🔍 问题分析

从 PM2 日志看，飞书文档被重定向到登录页面：
```
"location": "https://accounts.feishu.cn/accounts/page/login?..."
```

这说明文档需要登录才能访问，不是公开文档。

---

## ✅ 已修复

我已经改进了错误处理：
1. **检测登录重定向**：当检测到 URL 包含 `login`、`auth` 或 `accounts.feishu.cn` 时，立即抛出错误
2. **内容验证**：在返回结果前，检查内容是否为空或过短，如果是，再次检查是否是登录页面
3. **友好错误提示**：错误信息会明确告诉用户"文档需要登录才能访问，请确保文档已设置为公开"

---

## 🚀 部署修复

在宝塔终端执行：

```bash
cd /www/wwwroot/feihub/backend

# 1. 拉取最新代码（如果使用 Git）
# git pull origin main

# 或者直接修改文件（如果还没有推送到 Git）
# 我已经修改了 backend/src/lib/feishu-puppeteer.ts

# 2. 重新构建
npm run build

# 3. 重启 PM2
pm2 restart feihub-backend

# 4. 查看启动日志
pm2 logs feihub-backend --lines 20 --nostream
```

---

## 📝 修改的文件

- `backend/src/lib/feishu-puppeteer.ts`
  - 第 87-95 行：检测登录重定向，立即抛出错误
  - 第 564-585 行：在返回结果前验证内容，检查是否是登录页面

---

## ✅ 验证修复

修复后，重新提交一个**需要登录的文档**，应该会看到：

1. **后端日志**：
   ```
   [Puppeteer] ❌ 文档需要登录才能访问。请确保文档已设置为"公开"或"任何人可查看"。当前 URL 已重定向到: https://accounts.feishu.cn/...
   [处理文档] 处理失败: 文档需要登录才能访问...
   ```

2. **数据库**：
   - `documentSubmission.status` 应该是 `"failed"`
   - `documentSubmission.error` 应该包含错误信息

3. **前端**：
   - 临时文档（"内容正在联网获取..."）应该被删除或更新为错误状态

---

## 🔧 如何让文档可访问

要让飞书文档可以被爬取，需要：

1. **打开飞书文档**
2. **点击右上角的"分享"按钮**
3. **选择"任何人可查看"或"公开"**
4. **复制链接并重新提交**

---

## 🆘 如果还是不行

如果修复后还是不行，请把以下信息发给我：

1. **PM2 日志**（最近 100 行）：
   ```bash
   pm2 logs feihub-backend --lines 100 --nostream | tail -50
   ```

2. **文档链接**：确认文档是否已设置为公开

3. **错误信息**：查看 `documentSubmission.error` 字段


